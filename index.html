<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR Close Automation - Full Platform</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .animate-spin { animation: spin 1s linear infinite; }
    .animate-pulse { animation: pulse 2s ease-in-out infinite; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Icon component
    const Icon = ({ name, size = 18, color = 'currentColor', className = '' }) => {
      const icons = {
        'check-circle': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22,4 12,14.01 9,11.01"/></svg>,
        'x-circle': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>,
        'alert-triangle': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
        'chevron-down': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="6,9 12,15 18,9"/></svg>,
        'chevron-right': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="9,18 15,12 9,6"/></svg>,
        'calendar': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
        'play': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="5,3 19,12 5,21 5,3"/></svg>,
        'history': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/><path d="M12 7v5l4 2"/></svg>,
        'link-2': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 17H7A5 5 0 0 1 7 7h2"/><path d="M15 7h2a5 5 0 1 1 0 10h-2"/><line x1="8" y1="12" x2="16" y2="12"/></svg>,
        'log-out': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16,17 21,12 16,7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
        'loader': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
        'file-text': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10,9 9,9 8,9"/></svg>,
        'dollar-sign': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
        'credit-card': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>,
        'sparkles': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>,
        'check': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20,6 9,17 4,12"/></svg>,
        'x': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
        'external-link': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15,3 21,3 21,9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>,
        'refresh-cw': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="23,4 23,10 17,10"/><polyline points="1,20 1,14 7,14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
        'building': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="4" y="2" width="16" height="20" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M16 14h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/></svg>,
        'database': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>,
        'upload': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
        'download': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
        'lock': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
        'unlock': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>,
        'target': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
        'git-merge': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="18" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><path d="M6 21V9a9 9 0 0 0 9 9"/></svg>,
        'trending-up': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
        'shield': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
        'clipboard': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>,
        'edit': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
        'scale': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/></svg>,
        'layers': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>,
        'zap': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
        'settings': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
        'bar-chart': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>,
        'info': <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>,
      };
      return icons[name] || null;
    };

    // Color palette
    const colors = {
      primary: '#2CA01C', primaryDark: '#1E7A14', primaryLight: '#E8F5E6',
      secondary: '#0077C5', secondaryLight: '#E6F3FA',
      slate: '#393A3D', slateLight: '#6B6C72',
      background: '#F4F5F7', white: '#FFFFFF', border: '#D4D7DC',
      warning: '#FF9800', warningLight: '#FFF3E0',
      error: '#D32F2F', errorLight: '#FFEBEE',
      purple: '#7B1FA2', purpleLight: '#F3E5F5',
      teal: '#00897B', tealLight: '#E0F2F1',
    };

    // Format currency
    const fmt = (n) => `$${n.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;

    // Components
    const Badge = ({ children, variant = 'default', size = 'md' }) => {
      const variants = {
        default: { bg: colors.slateLight, text: colors.white },
        success: { bg: colors.primary, text: colors.white },
        successLight: { bg: colors.primaryLight, text: colors.primaryDark },
        warning: { bg: colors.warning, text: colors.white },
        warningLight: { bg: colors.warningLight, text: '#E65100' },
        error: { bg: colors.error, text: colors.white },
        errorLight: { bg: colors.errorLight, text: colors.error },
        blue: { bg: colors.secondary, text: colors.white },
        blueLight: { bg: colors.secondaryLight, text: colors.secondary },
        purple: { bg: colors.purple, text: colors.white },
        purpleLight: { bg: colors.purpleLight, text: colors.purple },
        orange: { bg: '#FF6D00', text: colors.white },
        orangeLight: { bg: '#FFF3E0', text: '#E65100' },
        teal: { bg: colors.teal, text: colors.white },
        tealLight: { bg: colors.tealLight, text: colors.teal },
      };
      const sizes = { sm: { padding: '2px 8px', fontSize: '10px' }, md: { padding: '4px 10px', fontSize: '11px' } };
      const s = variants[variant] || variants.default;
      const sz = sizes[size] || sizes.md;
      return <span style={{ display: 'inline-flex', alignItems: 'center', gap: '4px', padding: sz.padding, borderRadius: '4px', fontSize: sz.fontSize, fontWeight: 600, backgroundColor: s.bg, color: s.text, textTransform: 'uppercase', letterSpacing: '0.5px' }}>{children}</span>;
    };

    const Card = ({ children, style = {}, onClick }) => (
      <div onClick={onClick} style={{ backgroundColor: colors.white, borderRadius: '8px', border: `1px solid ${colors.border}`, padding: '20px', boxShadow: '0 1px 3px rgba(0,0,0,0.08)', cursor: onClick ? 'pointer' : 'default', ...style }}>{children}</div>
    );

    const Button = ({ children, variant = 'primary', size = 'md', iconName, disabled, onClick, style = {} }) => {
      const variants = {
        primary: { bg: colors.primary, text: colors.white, border: 'none' },
        secondary: { bg: colors.white, text: colors.slate, border: `1px solid ${colors.border}` },
        danger: { bg: colors.white, text: colors.error, border: `1px solid ${colors.error}` },
        ghost: { bg: 'transparent', text: colors.slateLight, border: 'none' },
      };
      const sizes = { sm: { padding: '6px 12px', fontSize: '12px' }, md: { padding: '10px 18px', fontSize: '14px' }, lg: { padding: '12px 24px', fontSize: '15px' } };
      const v = variants[variant]; const s = sizes[size];
      return <button onClick={onClick} disabled={disabled} style={{ display: 'inline-flex', alignItems: 'center', gap: '8px', padding: s.padding, fontSize: s.fontSize, fontWeight: 600, borderRadius: '6px', backgroundColor: disabled ? colors.border : v.bg, color: disabled ? colors.slateLight : v.text, border: v.border, cursor: disabled ? 'not-allowed' : 'pointer', ...style }}>{iconName && <Icon name={iconName} size={16} />}{children}</button>;
    };

    const Checkbox = ({ checked, onChange }) => (
      <div onClick={onChange} style={{ width: '18px', height: '18px', borderRadius: '4px', border: checked ? 'none' : `2px solid ${colors.border}`, backgroundColor: checked ? colors.primary : colors.white, display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer' }}>
        {checked && <Icon name="check" size={12} color={colors.white} />}
      </div>
    );

    const ProgressBar = ({ value, max, color = colors.primary }) => (
      <div style={{ height: '6px', backgroundColor: colors.border, borderRadius: '3px', overflow: 'hidden' }}>
        <div style={{ height: '100%', width: `${(value/max)*100}%`, backgroundColor: color, borderRadius: '3px', transition: 'width 0.3s ease' }} />
      </div>
    );

    const StatCard = ({ icon, label, value, subValue, color = colors.primary }) => (
      <Card style={{ flex: 1, minWidth: '160px' }}>
        <div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>
          <div style={{ width: '36px', height: '36px', borderRadius: '8px', backgroundColor: `${color}15`, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
            <Icon name={icon} size={18} color={color} />
          </div>
          <div>
            <div style={{ fontSize: '12px', color: colors.slateLight, marginBottom: '2px' }}>{label}</div>
            <div style={{ fontSize: '20px', fontWeight: 700, color: colors.slate }}>{value}</div>
            {subValue && <div style={{ fontSize: '11px', color: colors.slateLight }}>{subValue}</div>}
          </div>
        </div>
      </Card>
    );

    // Mock Data
    const mockEntities = [
      { id: 'realm_123456', name: 'Acme Corporation', type: 'Primary' },
      { id: 'realm_789012', name: 'Acme Europe GmbH', type: 'Subsidiary' },
    ];

    const mockARAccounts = [
      { id: 'acc_1', name: 'Accounts Receivable (A/R)', number: '1200', balance: 156750.00, isPrimary: true },
      { id: 'acc_2', name: 'AR - Trade', number: '1210', balance: 12500.00, isPrimary: false },
      { id: 'acc_3', name: 'AR - Intercompany', number: '1220', balance: 8200.00, isPrimary: false },
    ];

    const mockAssets = [
      { id: 'asset_1', name: 'Stripe Billing Register', type: 'connector', status: 'connected', required: true },
      { id: 'asset_2', name: 'Bank Feed (Chase)', type: 'connector', status: 'connected', required: true },
      { id: 'asset_3', name: 'Gmail (Invoices & Receipts)', type: 'connector', status: 'connected', required: false, description: 'Parse emails for invoice attachments and payment confirmations' },
      { id: 'asset_4', name: 'Transaction Spreadsheet', type: 'upload', status: 'uploaded', required: true, fileName: 'Jan_2024_AR_Transactions.xlsx', records: 156 },
      { id: 'asset_5', name: 'Billing Export (Jan)', type: 'upload', status: 'uploaded', required: true },
      { id: 'asset_6', name: 'Remittance Advice', type: 'upload', status: 'optional', required: false },
    ];

    // SOP-Based Adjustment Rules (loaded from customer's uploaded SOPs)
    const mockSOPRules = [
      {
        id: 'rule_netting',
        category: 'Netting',
        name: 'AR/AP Netting for Dual-Role Entities',
        enabled: true,
        priority: 1,
        conditions: [
          'Customer exists in both AR and AP sub-ledgers (matched by Tax ID or exact legal name)',
          'Both AR balance > $0 AND AP balance > $0 for the same entity',
          'Offset AR against AP: JE amount = MIN(AR Balance, AP Balance)',
          'Result: Remaining balance in whichever ledger was larger (AR or AP), other ledger = $0',
          'Exclude entities flagged as "No Netting" in customer master'
        ],
        action: 'Create Journal Entry: Dr Accounts Payable, Cr Accounts Receivable for the offset amount; clears the smaller balance entirely',
        glAccounts: { debit: '2000 - Accounts Payable', credit: '1200 - Accounts Receivable' },
        approvalRequired: true,
        lastModified: '2024-01-15',
        modifiedBy: 'Controller'
      },
      {
        id: 'rule_baddebt_90',
        category: 'Bad Debt',
        name: 'Automatic Bad Debt Write-off (90+ Days, Under $500)',
        enabled: true,
        priority: 2,
        conditions: [
          'Invoice aging > 90 days past due date',
          'Outstanding balance ≤ $500.00',
          'No payment activity in last 60 days',
          'Customer does not have "Strategic Account" flag',
          'At least 2 collection attempts documented (check Notes field)'
        ],
        action: 'Create Credit Memo to close invoice; Post to Bad Debt Expense',
        glAccounts: { debit: '6200 - Bad Debt Expense', credit: '1200 - Accounts Receivable' },
        approvalRequired: false,
        lastModified: '2024-01-10',
        modifiedBy: 'Controller'
      },
      {
        id: 'rule_baddebt_large',
        category: 'Bad Debt',
        name: 'Large Balance Write-off (Over $500)',
        enabled: true,
        priority: 3,
        conditions: [
          'Invoice aging > 120 days past due date',
          'Outstanding balance > $500.00',
          'Written approval from Controller required',
          'Must have supporting documentation (collection letters, legal notice)'
        ],
        action: 'Create Credit Memo with Controller approval; Post to Bad Debt Expense',
        glAccounts: { debit: '6200 - Bad Debt Expense', credit: '1200 - Accounts Receivable' },
        approvalRequired: true,
        escalateTo: 'Controller',
        lastModified: '2024-01-10',
        modifiedBy: 'CFO'
      },
      {
        id: 'rule_smallbalance',
        category: 'Small Balance',
        name: 'De Minimis Balance Clearing',
        enabled: true,
        priority: 4,
        conditions: [
          'Remaining invoice balance ≤ $1.00 (absolute value)',
          'Balance resulted from rounding, partial payment, or currency conversion',
          'Original invoice was ≥ 95% paid'
        ],
        action: 'Write off to Miscellaneous Expense (rounding); No customer notification',
        glAccounts: { debit: '6900 - Misc Expense', credit: '1200 - Accounts Receivable' },
        approvalRequired: false,
        lastModified: '2023-12-01',
        modifiedBy: 'Controller'
      },
      {
        id: 'rule_shortpay',
        category: 'Short Payment',
        name: 'Short Payment Resolution (Under $250)',
        enabled: true,
        priority: 5,
        conditions: [
          'Payment received is less than invoice amount',
          'Variance (Invoice - Payment) ≤ $250.00',
          'Customer memo/remittance does NOT indicate dispute',
          'Variance is ≤ 5% of original invoice amount'
        ],
        action: 'Apply payment to invoice; Write off variance to Sales Allowance if no dispute indicated',
        glAccounts: { debit: '4100 - Sales Allowance', credit: '1200 - Accounts Receivable' },
        approvalRequired: false,
        lastModified: '2024-01-05',
        modifiedBy: 'AR Manager'
      },
      {
        id: 'rule_overpay',
        category: 'Overpayment',
        name: 'Overpayment Handling',
        enabled: true,
        priority: 6,
        conditions: [
          'Payment amount exceeds total open AR for customer',
          'IF overpayment ≤ $100: Apply to oldest invoices, leave remainder as credit on account',
          'IF overpayment > $100: Apply to invoices, create Customer Credit for refund review'
        ],
        action: 'Apply to open invoices by due date (oldest first); Excess to Customer Credits',
        glAccounts: { credit: '2100 - Customer Deposits' },
        approvalRequired: true,
        lastModified: '2024-01-08',
        modifiedBy: 'AR Manager'
      },
      {
        id: 'rule_dimension',
        category: 'Dimension Integrity',
        name: 'Mandatory Dimension Inheritance',
        enabled: true,
        priority: 0,
        conditions: [
          'ALL adjustment transactions (JE, Credit Memo, Write-off) MUST inherit:',
          '  → Class from source invoice',
          '  → Location from source invoice',
          '  → Project/Job from source invoice (if applicable)',
          'If source has multiple dimensions, split adjustment proportionally'
        ],
        action: 'System enforced: Block any adjustment that would create "Unclassified" entries',
        glAccounts: null,
        approvalRequired: false,
        lastModified: '2023-11-15',
        modifiedBy: 'CFO'
      },
      {
        id: 'rule_interco',
        category: 'Intercompany',
        name: 'Intercompany AR Elimination',
        enabled: true,
        priority: 7,
        conditions: [
          'Customer is flagged as "Intercompany Entity" in customer master',
          'Matching AP exists in sister entity for same invoice reference',
          'Both entities are in consolidation scope'
        ],
        action: 'Create elimination Journal Entry; Tag with "IC-ELIM" for consolidation',
        glAccounts: { debit: '1220 - AR Intercompany', credit: '2020 - AP Intercompany' },
        approvalRequired: true,
        escalateTo: 'Controller',
        lastModified: '2024-01-12',
        modifiedBy: 'Controller'
      }
    ];

    const mockExecutionPlan = [
      { id: 1, step: 'Pull AR Aging Reports', lane: 'auto', status: 'pending', inputs: 'Close Date', risk: 'none' },
      { id: 2, step: 'Pull GL Trial Balance', lane: 'auto', status: 'pending', inputs: 'AR Control Account', risk: 'none' },
      { id: 3, step: 'Pull Open Invoices', lane: 'auto', status: 'pending', inputs: 'QBO API', risk: 'none' },
      { id: 4, step: 'Pull Unapplied Payments', lane: 'auto', status: 'pending', inputs: 'QBO API', risk: 'none' },
      { id: 5, step: 'Pull Bank Context', lane: 'auto', status: 'pending', inputs: 'Bank Feed', risk: 'none' },
      { id: 6, step: 'Parse External Billing', lane: 'auto', status: 'pending', inputs: 'Stripe + Upload', risk: 'none' },
      { id: 7, step: 'Execute Payment Matching', lane: 'draft+confirm', status: 'pending', inputs: 'AI Engine', risk: 'medium' },
      { id: 8, step: 'Gap Analysis', lane: 'draft+confirm', status: 'pending', inputs: 'External vs QBO', risk: 'medium' },
      { id: 9, step: 'Apply Adjustments', lane: 'draft+confirm', status: 'pending', inputs: 'SOP Rules', risk: 'high' },
      { id: 10, step: 'GL Tie-Out Validation', lane: 'auto', status: 'pending', inputs: 'Final Reports', risk: 'none' },
    ];

    const mockDataPullProgress = [
      { id: 1, name: 'AR Aging Summary', status: 'complete', records: 47, time: '1.2s', source: 'QBO' },
      { id: 2, name: 'AR Aging Detail', status: 'complete', records: 312, time: '2.8s', source: 'QBO' },
      { id: 3, name: 'Trial Balance', status: 'complete', records: 1, time: '0.8s', source: 'QBO' },
      { id: 4, name: 'Open Invoices', status: 'complete', records: 47, time: '3.1s', source: 'QBO' },
      { id: 5, name: 'Unapplied Payments', status: 'complete', records: 12, time: '1.5s', source: 'QBO' },
      { id: 6, name: 'Credits & Adjustments', status: 'complete', records: 5, time: '0.9s', source: 'QBO' },
      { id: 7, name: 'Bank Feed (Deposits)', status: 'complete', records: 8, time: '1.1s', source: 'Bank' },
      { id: 8, name: 'Stripe Billing Register', status: 'complete', records: 52, time: '2.3s', source: 'Stripe' },
      { id: 9, name: 'Gmail Invoice Attachments', status: 'complete', records: 23, time: '8.4s', source: 'Gmail' },
      { id: 10, name: 'Gmail Payment Confirmations', status: 'complete', records: 15, time: '4.2s', source: 'Gmail' },
      { id: 11, name: 'Transaction Spreadsheet', status: 'complete', records: 156, time: '1.8s', source: 'Upload' },
    ];

    // Gmail parsed invoices - invoices found in email attachments
    const mockGmailInvoices = [
      { id: 'GMAIL-001', subject: 'Invoice #2024-0892 from Vendor Systems', sender: 'billing@vendorsystems.com', date: '2024-01-18', customer: 'Vendor Systems Inc', amount: 3200.00, attachmentName: 'Invoice_2024-0892.pdf', matchStatus: 'missing_in_qbo' },
      { id: 'GMAIL-002', subject: 'Your Invoice INV-44521', sender: 'ar@cloudservices.io', date: '2024-01-22', customer: 'Cloud Services Co', amount: 875.00, attachmentName: 'INV-44521.pdf', matchStatus: 'missing_in_qbo' },
      { id: 'GMAIL-003', subject: 'Invoice for January Services', sender: 'accounts@deltacorp.com', date: '2024-01-25', customer: 'Delta Corp', amount: 1450.00, attachmentName: 'DeltaCorp_Jan2024.pdf', matchStatus: 'matched', qboInvoice: 'INV-1041' },
    ];

    // Gmail payment confirmations - payment receipts found in emails
    const mockGmailPayments = [
      { id: 'GMAIL-PMT-001', subject: 'Payment Confirmation - $4,500.00', sender: 'payments@acmecorp.com', date: '2024-01-28', customer: 'Acme Corp', amount: 4500.00, matchStatus: 'matched', qboPayment: 'PMT-5501' },
      { id: 'GMAIL-PMT-002', subject: 'Wire Transfer Confirmation', sender: 'treasury@globalind.com', date: '2024-01-30', customer: 'Global Industries', amount: 8750.00, matchStatus: 'matched', qboPayment: 'PMT-5503' },
      { id: 'GMAIL-PMT-003', subject: 'Payment Sent - Check #4412', sender: 'ap@newcustomer.com', date: '2024-01-29', customer: 'New Customer LLC', amount: 2100.00, matchStatus: 'missing_in_qbo' },
    ];

    // Spreadsheet transactions - uploaded AR transaction register
    const mockSpreadsheetData = {
      fileName: 'Jan_2024_AR_Transactions.xlsx',
      uploadDate: '2024-01-31',
      totalRecords: 156,
      summary: {
        invoices: { count: 52, total: 168500.00 },
        payments: { count: 48, total: 142300.00 },
        credits: { count: 6, total: 3200.00 },
        adjustments: { count: 4, total: 1850.00 },
      },
      discrepancies: [
        { type: 'invoice', ref: 'SS-INV-0124', customer: 'Midwest Manufacturing', amount: 4200.00, date: '2024-01-15', issue: 'Not found in QBO', action: 'create_invoice' },
        { type: 'invoice', ref: 'SS-INV-0131', customer: 'Pacific Trade Co', amount: 1850.00, date: '2024-01-20', issue: 'Not found in QBO', action: 'create_invoice' },
        { type: 'payment', ref: 'SS-PMT-0089', customer: 'Acme Corp', amount: 6000.00, date: '2024-01-28', issue: 'Amount mismatch (QBO: $5,500)', action: 'investigate' },
        { type: 'credit', ref: 'SS-CM-0012', customer: 'ReturnCo Inc', amount: 500.00, date: '2024-01-22', issue: 'Not found in QBO', action: 'create_credit' },
      ],
      matched: {
        invoices: 50,
        payments: 47,
        credits: 5,
      }
    };

    const mockInvoices = [
      { id: 'INV-1042', customer: 'Acme Corp', date: '2024-01-05', dueDate: '2024-02-04', amount: 4500.00, balance: 4500.00, aging: 'Current', class: 'Consulting' },
      { id: 'INV-1043', customer: 'TechStart LLC', date: '2024-01-08', dueDate: '2024-02-07', amount: 2250.00, balance: 2250.00, aging: 'Current', class: 'Software' },
      { id: 'INV-1044', customer: 'Global Industries', date: '2024-01-10', dueDate: '2024-02-09', amount: 8750.00, balance: 8750.00, aging: 'Current', class: 'Hardware' },
      { id: 'INV-1045', customer: 'Acme Corp', date: '2024-01-12', dueDate: '2024-02-11', amount: 1500.00, balance: 1500.00, aging: 'Current', class: 'Consulting' },
      { id: 'INV-1046', customer: 'Smith & Co', date: '2023-12-15', dueDate: '2024-01-14', amount: 3200.00, balance: 3200.00, aging: '1-30', class: 'Services' },
      { id: 'INV-1038', customer: 'Beta Holdings', date: '2023-11-20', dueDate: '2023-12-20', amount: 950.00, balance: 950.00, aging: '31-60', class: 'Consulting' },
      { id: 'INV-1029', customer: 'Old Client Inc', date: '2023-09-01', dueDate: '2023-10-01', amount: 125.00, balance: 125.00, aging: '90+', class: 'Legacy' },
    ];

    const mockPayments = [
      { id: 'PMT-5501', customer: 'Acme Corp', date: '2024-01-28', amount: 6000.00, unapplied: 6000.00, ref: 'CHK-8842', memo: 'Jan invoices', method: 'Check' },
      { id: 'PMT-5502', customer: 'TechStart LLC', date: '2024-01-29', amount: 2250.00, unapplied: 2250.00, ref: 'ACH-1129', memo: 'INV-1043', method: 'ACH' },
      { id: 'PMT-5503', customer: 'Global Industries', date: '2024-01-30', amount: 8750.00, unapplied: 8750.00, ref: 'WIRE-445', memo: 'Payment for inv 1044', method: 'Wire' },
      { id: 'PMT-5504', customer: 'Smith & Co', date: '2024-01-30', amount: 3000.00, unapplied: 3000.00, ref: 'CHK-2201', memo: 'Partial', method: 'Check' },
      { id: 'PMT-5505', customer: 'Unknown Sender', date: '2024-01-25', amount: 1200.00, unapplied: 1200.00, ref: 'ACH-9912', memo: '', method: 'ACH' },
    ];

    const mockBankDeposits = [
      { id: 'DEP-001', date: '2024-01-31', amount: 2500.00, description: 'DEPOSIT TECHSTART LLC', status: 'unmatched' },
      { id: 'DEP-002', date: '2024-01-31', amount: 500.00, description: 'STRIPE PAYOUT', status: 'unmatched' },
    ];

    const mockMatches = [
      { tier: 1, confidence: 'exact', paymentId: 'PMT-5502', payment: mockPayments[1], invoices: [mockInvoices[1]], amountApplied: 2250.00, reasoning: "Perfect match: Payment of $2,250.00 exactly matches Invoice #1043 balance. Customer names match (TechStart LLC). Memo explicitly references 'INV-1043'. ACH provides reliable trail.", approved: true, type: 'standard' },
      { tier: 1, confidence: 'exact', paymentId: 'PMT-5503', payment: mockPayments[2], invoices: [mockInvoices[2]], amountApplied: 8750.00, reasoning: "Perfect match: Payment of $8,750.00 exactly equals Invoice #1044. Customer 'Global Industries' confirmed. Memo references 'inv 1044'. Wire transfer provides high reliability.", approved: true, type: 'standard' },
      { tier: 2, confidence: 'high', paymentId: 'PMT-5501', payment: mockPayments[0], invoices: [mockInvoices[0], mockInvoices[3]], amountApplied: 6000.00, reasoning: "Multi-invoice match: $6,000 from Acme Corp = INV-1042 ($4,500) + INV-1045 ($1,500). Memo 'Jan invoices' supports batch payment. Same customer, dimensions preserved.", approved: true, type: 'multi' },
      { tier: 3, confidence: 'medium', paymentId: 'PMT-5504', payment: mockPayments[3], invoices: [mockInvoices[4]], amountApplied: 3000.00, writeOff: 200.00, reasoning: "Partial payment: $3,000 from Smith & Co vs Invoice #1046 of $3,200. Memo says 'Partial'. Per SOP: balances under $250 eligible for write-off. Recommend applying $3,000 + $200 write-off.", approved: true, type: 'partial' },
      { tier: 3, confidence: 'low', paymentId: 'PMT-5505', payment: mockPayments[4], invoices: [], amountApplied: 0, reasoning: "Unable to match: Payment of $1,200 from 'Unknown Sender'. No memo, no customer match found. Requires manual investigation or additional remittance advice.", approved: false, type: 'unmatched' },
    ];

    const mockGhostCash = [
      { id: 'GHOST-1', bankRef: 'DEP-001', amount: 2500.00, suggestedCustomer: 'TechStart LLC', suggestedInvoice: null, confidence: 'low', reasoning: "Bank description mentions TECHSTART. No open invoice matches $2,500. May be advance payment or unrecorded invoice." },
    ];

    const mockGapAnalysis = [
      { id: 'GAP-1', externalRef: 'STRIPE-8821', customer: 'NewCo Inc', amount: 1500.00, date: '2024-01-28', source: 'Stripe', status: 'missing_in_qbo', action: 'create_invoice' },
      { id: 'GAP-2', externalRef: 'STRIPE-8834', customer: 'FastGrow LLC', amount: 750.00, date: '2024-01-29', source: 'Stripe', status: 'missing_in_qbo', action: 'create_invoice' },
    ];

    const mockAdjustments = [
      { id: 'ADJ-1', type: 'netting', customer: 'Acme Corp', arBalance: 1500.00, apBalance: 1200.00, offsetAmount: 1200.00, remainingAR: 300.00, remainingAP: 0.00, reasoning: "AR/AP Netting: Acme Corp has $1,500 AR and $1,200 AP. Offset the balances by creating JE: Dr AP $1,200, Cr AR $1,200. Result: AP is fully cleared ($0), AR has remaining balance of $300.", approved: true },
      { id: 'ADJ-2', type: 'write_off', customer: 'Old Client Inc', balance: 125.00, aging: '90+', reason: 'Uncollectible', reasoning: "Bad Debt Write-off: Invoice INV-1029 is 120+ days overdue. Balance $125 is under $500 threshold per SOP. Recommend write-off to Bad Debt Expense.", approved: true },
      { id: 'ADJ-3', type: 'small_balance', customer: 'Beta Holdings', balance: 0.47, aging: '31-60', reason: 'Rounding', reasoning: "Small Balance Clearing: Remaining balance of $0.47 after partial payment. Per SOP, balances under $1.00 can be written off. Recommend clearing to Misc Expense.", approved: true },
    ];

    const mockTieOut = {
      glBalance: 156750.00,
      agingTotal: 156750.00,
      variance: 0.00,
      status: 'balanced',
      breakdown: {
        current: 17000.00,
        aging1_30: 3200.00,
        aging31_60: 950.00,
        aging61_90: 0.00,
        aging90plus: 125.00,
      }
    };

    // Main App
    function App() {
      const [phase, setPhase] = useState('setup'); // setup, data_pull, matching, gap_analysis, adjustments, tieout, complete
      const [setupStep, setSetupStep] = useState(1);
      const [connected, setConnected] = useState(false);
      const [selectedEntity, setSelectedEntity] = useState(null);
      const [closeDate, setCloseDate] = useState('2024-01-31');
      const [selectedARAccounts, setSelectedARAccounts] = useState([mockARAccounts[0].id]); // Multi-select: array of account IDs
      const [planApproved, setPlanApproved] = useState(false);
      const [matches, setMatches] = useState(mockMatches);
      const [adjustments, setAdjustments] = useState(mockAdjustments);
      const [gapItems, setGapItems] = useState(mockGapAnalysis);
      const [expandedSections, setExpandedSections] = useState({});
      const [uploadState, setUploadState] = useState('idle'); // idle, dragging, uploading, parsing, complete
      const [uploadProgress, setUploadProgress] = useState(0);
      const [uploadedFile, setUploadedFile] = useState(null);

      const simulateUpload = () => {
        setUploadState('uploading');
        setUploadProgress(0);

        // Simulate upload progress
        const uploadInterval = setInterval(() => {
          setUploadProgress(prev => {
            if (prev >= 100) {
              clearInterval(uploadInterval);
              setUploadState('parsing');
              // Simulate parsing
              setTimeout(() => {
                setUploadState('complete');
                setUploadedFile({
                  name: 'Jan_2024_AR_Transactions.xlsx',
                  size: '2.4 MB',
                  records: 156,
                  sheets: ['Invoices', 'Payments', 'Credits'],
                });
              }, 1500);
              return 100;
            }
            return prev + Math.random() * 15 + 5;
          });
        }, 200);
      };

      const toggleSection = (key) => setExpandedSections(prev => ({ ...prev, [key]: !prev[key] }));
      const toggleMatch = (idx) => setMatches(prev => prev.map((m, i) => i === idx ? { ...m, approved: !m.approved } : m));
      const toggleAdjustment = (idx) => setAdjustments(prev => prev.map((a, i) => i === idx ? { ...a, approved: !a.approved } : a));
      const toggleGap = (idx) => setGapItems(prev => prev.map((g, i) => i === idx ? { ...g, approved: !g.approved } : g));
      const toggleARAccount = (accId) => setSelectedARAccounts(prev =>
        prev.includes(accId) ? prev.filter(id => id !== accId) : [...prev, accId]
      );
      const selectedARAccountsData = mockARAccounts.filter(acc => selectedARAccounts.includes(acc.id));
      const totalSelectedARBalance = selectedARAccountsData.reduce((sum, acc) => sum + acc.balance, 0);

      const navItems = [
        { id: 'setup', label: 'Run Setup', icon: 'settings', enabled: true },
        { id: 'data_pull', label: 'Data Pull', icon: 'database', enabled: planApproved },
        { id: 'matching', label: 'Payment Matching', icon: 'git-merge', enabled: planApproved },
        { id: 'gap_analysis', label: 'Gap Analysis', icon: 'target', enabled: planApproved },
        { id: 'adjustments', label: 'Adjustments', icon: 'scale', enabled: planApproved },
        { id: 'tieout', label: 'Tie-Out', icon: 'check-circle', enabled: planApproved },
      ];

      const laneColors = { 'auto': 'tealLight', 'draft+confirm': 'blueLight', 'ask': 'warningLight', 'escalate': 'errorLight' };

      return (
        <div style={{ display: 'flex', minHeight: '100vh', backgroundColor: colors.background, fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif' }}>
          {/* Sidebar */}
          <div style={{ width: '240px', backgroundColor: colors.white, borderRight: `1px solid ${colors.border}`, padding: '20px 0', display: 'flex', flexDirection: 'column' }}>
            <div style={{ padding: '0 20px 20px', borderBottom: `1px solid ${colors.border}` }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                <div style={{ width: '36px', height: '36px', borderRadius: '8px', backgroundColor: colors.primary, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                  <Icon name="refresh-cw" size={20} color={colors.white} />
                </div>
                <div>
                  <div style={{ fontWeight: 700, color: colors.slate, fontSize: '15px' }}>AR Close</div>
                  <div style={{ fontSize: '11px', color: colors.slateLight }}>Automation Agent</div>
                </div>
              </div>
            </div>

            <nav style={{ padding: '12px 8px', flex: 1 }}>
              {navItems.map((item, idx) => (
                <button key={item.id} onClick={() => item.enabled && setPhase(item.id)} disabled={!item.enabled}
                  style={{ width: '100%', display: 'flex', alignItems: 'center', gap: '10px', padding: '10px 12px', marginBottom: '2px', borderRadius: '6px', border: 'none', backgroundColor: phase === item.id ? colors.primaryLight : 'transparent', color: !item.enabled ? colors.border : phase === item.id ? colors.primaryDark : colors.slateLight, fontSize: '13px', fontWeight: phase === item.id ? 600 : 400, cursor: item.enabled ? 'pointer' : 'not-allowed', textAlign: 'left' }}>
                  <Icon name={item.icon} size={16} />
                  {item.label}
                  {phase === item.id && <div style={{ marginLeft: 'auto', width: '6px', height: '6px', borderRadius: '3px', backgroundColor: colors.primary }} />}
                </button>
              ))}
            </nav>

            {connected && (
              <div style={{ padding: '12px 20px', borderTop: `1px solid ${colors.border}`, fontSize: '12px' }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '6px', color: colors.primary, fontWeight: 600, marginBottom: '4px' }}>
                  <Icon name="check-circle" size={14} /> Connected
                </div>
                <div style={{ color: colors.slateLight }}>{selectedEntity?.name}</div>
                <div style={{ color: colors.slateLight, fontSize: '11px' }}>Close: {closeDate}</div>
              </div>
            )}
          </div>

          {/* Main Content */}
          <div style={{ flex: 1, padding: '24px 32px', overflowY: 'auto', maxHeight: '100vh' }}>

            {/* SETUP PHASE */}
            {phase === 'setup' && (
              <div style={{ maxWidth: '900px' }}>
                <h1 style={{ fontSize: '24px', fontWeight: 700, color: colors.slate, marginBottom: '4px' }}>Run Setup & Context Loading</h1>
                <p style={{ fontSize: '14px', color: colors.slateLight, marginBottom: '24px' }}>Configure the AR Close run parameters and validate required assets</p>

                {/* Progress Steps */}
                <div style={{ display: 'flex', gap: '8px', marginBottom: '24px' }}>
                  {['Connect', 'Entity', 'AR Account', 'SOP Rules', 'Assets', 'Plan'].map((step, i) => (
                    <div key={i} style={{ flex: 1, textAlign: 'center' }}>
                      <div style={{ height: '4px', backgroundColor: i < setupStep ? colors.primary : i === setupStep ? colors.secondary : colors.border, borderRadius: '2px', marginBottom: '6px' }} />
                      <div style={{ fontSize: '11px', color: i <= setupStep ? colors.slate : colors.slateLight, fontWeight: i === setupStep ? 600 : 400 }}>{step}</div>
                    </div>
                  ))}
                </div>

                {/* Step 1: Connect */}
                {setupStep === 1 && (
                  <Card>
                    <div style={{ textAlign: 'center', padding: '32px' }}>
                      <div style={{ width: '64px', height: '64px', borderRadius: '12px', backgroundColor: colors.primaryLight, display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto 16px' }}>
                        <Icon name="link-2" size={28} color={colors.primary} />
                      </div>
                      <h2 style={{ fontSize: '18px', fontWeight: 600, color: colors.slate, marginBottom: '8px' }}>Connect to QuickBooks Online</h2>
                      <p style={{ fontSize: '14px', color: colors.slateLight, marginBottom: '20px', maxWidth: '400px', margin: '0 auto 20px' }}>Link your QBO account to pull financial data for the AR Close process</p>
                      <Button onClick={() => { setConnected(true); setSetupStep(2); }} size="lg" iconName="external-link">Connect to QuickBooks</Button>
                    </div>
                  </Card>
                )}

                {/* Step 2: Entity Selection */}
                {setupStep === 2 && (
                  <Card>
                    <h3 style={{ fontSize: '16px', fontWeight: 600, color: colors.slate, marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <Icon name="building" size={18} color={colors.secondary} /> Select Entity
                    </h3>
                    <p style={{ fontSize: '13px', color: colors.slateLight, marginBottom: '16px' }}>Choose the company/realm for this AR Close run</p>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', marginBottom: '20px' }}>
                      {mockEntities.map(entity => (
                        <div key={entity.id} onClick={() => setSelectedEntity(entity)}
                          style={{ padding: '14px 16px', border: `2px solid ${selectedEntity?.id === entity.id ? colors.primary : colors.border}`, borderRadius: '8px', cursor: 'pointer', backgroundColor: selectedEntity?.id === entity.id ? colors.primaryLight : colors.white }}>
                          <div style={{ fontWeight: 600, color: colors.slate }}>{entity.name}</div>
                          <div style={{ fontSize: '12px', color: colors.slateLight }}>{entity.id} • {entity.type}</div>
                        </div>
                      ))}
                    </div>
                    <div style={{ display: 'flex', gap: '12px' }}>
                      <Button variant="secondary" onClick={() => setSetupStep(1)}>Back</Button>
                      <Button onClick={() => setSetupStep(3)} disabled={!selectedEntity}>Continue</Button>
                    </div>
                  </Card>
                )}

                {/* Step 3: Close Date & AR Account */}
                {setupStep === 3 && (
                  <Card>
                    <h3 style={{ fontSize: '16px', fontWeight: 600, color: colors.slate, marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <Icon name="lock" size={18} color={colors.secondary} /> Close Date & AR Control Account
                    </h3>

                    <div style={{ marginBottom: '20px' }}>
                      <label style={{ display: 'block', fontSize: '13px', fontWeight: 500, color: colors.slateLight, marginBottom: '6px' }}>Global Date Lock</label>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <Icon name="calendar" size={18} color={colors.slateLight} />
                        <input type="date" value={closeDate} onChange={(e) => setCloseDate(e.target.value)}
                          style={{ padding: '10px 14px', fontSize: '14px', border: `1px solid ${colors.border}`, borderRadius: '6px', width: '180px' }} />
                      </div>
                      <div style={{ fontSize: '12px', color: colors.slateLight, marginTop: '4px' }}>All transactions after this date will be excluded</div>
                    </div>

                    <div style={{ marginBottom: '20px' }}>
                      <label style={{ display: 'block', fontSize: '13px', fontWeight: 500, color: colors.slateLight, marginBottom: '6px' }}>AR Control Account(s)</label>
                      <p style={{ fontSize: '12px', color: colors.slateLight, marginBottom: '10px' }}>Select all AR accounts to include in the tie-out. The agent will validate the combined balance against the GL.</p>
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                        {mockARAccounts.map(acc => {
                          const isSelected = selectedARAccounts.includes(acc.id);
                          return (
                            <div key={acc.id} onClick={() => toggleARAccount(acc.id)}
                              style={{ padding: '12px 14px', border: `2px solid ${isSelected ? colors.primary : colors.border}`, borderRadius: '8px', cursor: 'pointer', backgroundColor: isSelected ? colors.primaryLight : colors.white, display: 'flex', alignItems: 'center', gap: '12px' }}>
                              <Checkbox checked={isSelected} onChange={() => {}} />
                              <div style={{ flex: 1 }}>
                                <div style={{ fontWeight: 500, color: colors.slate, display: 'flex', alignItems: 'center', gap: '8px' }}>
                                  {acc.number} - {acc.name}
                                  {acc.isPrimary && <Badge variant="successLight" size="sm">Primary</Badge>}
                                </div>
                                <div style={{ fontSize: '11px', color: colors.slateLight, marginTop: '2px' }}>
                                  {acc.isPrimary ? 'Default A/R posting account' : acc.number === '1210' ? 'Trade receivables' : 'Intercompany receivables'}
                                </div>
                              </div>
                              <div style={{ fontWeight: 600, color: isSelected ? colors.primary : colors.slateLight }}>{fmt(acc.balance)}</div>
                            </div>
                          );
                        })}
                      </div>
                    </div>

                    {/* Selected Summary */}
                    {selectedARAccounts.length > 0 && (
                      <div style={{ padding: '12px 16px', backgroundColor: colors.primaryLight, borderRadius: '8px', marginBottom: '20px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <div>
                          <div style={{ fontSize: '12px', color: colors.primaryDark }}>Selected Accounts: {selectedARAccounts.length}</div>
                          <div style={{ fontSize: '11px', color: colors.slateLight }}>{selectedARAccountsData.map(a => a.number).join(', ')}</div>
                        </div>
                        <div style={{ textAlign: 'right' }}>
                          <div style={{ fontSize: '12px', color: colors.primaryDark }}>Combined AR Balance</div>
                          <div style={{ fontSize: '18px', fontWeight: 700, color: colors.primary }}>{fmt(totalSelectedARBalance)}</div>
                        </div>
                      </div>
                    )}

                    <div style={{ display: 'flex', gap: '12px' }}>
                      <Button variant="secondary" onClick={() => setSetupStep(2)}>Back</Button>
                      <Button onClick={() => setSetupStep(4)} disabled={selectedARAccounts.length === 0}>Continue</Button>
                    </div>
                  </Card>
                )}

                {/* Step 4: SOP Adjustment Rules Review */}
                {setupStep === 4 && (
                  <Card>
                    <h3 style={{ fontSize: '16px', fontWeight: 600, color: colors.slate, marginBottom: '4px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <Icon name="scale" size={18} color={colors.secondary} /> Adjustment Rules (from SOP)
                    </h3>
                    <p style={{ fontSize: '13px', color: colors.slateLight, marginBottom: '16px' }}>
                      These rules were extracted from your uploaded SOPs and will govern how the agent processes adjustments. Review and confirm they are current.
                    </p>

                    <div style={{ display: 'flex', gap: '8px', marginBottom: '16px', flexWrap: 'wrap' }}>
                      <Badge variant="blueLight">Netting</Badge>
                      <Badge variant="errorLight">Bad Debt</Badge>
                      <Badge variant="warningLight">Small Balance</Badge>
                      <Badge variant="purpleLight">Short Payment</Badge>
                      <Badge variant="tealLight">Overpayment</Badge>
                      <Badge variant="default">Dimension</Badge>
                    </div>

                    <div style={{ display: 'flex', flexDirection: 'column', gap: '12px', marginBottom: '20px', maxHeight: '400px', overflowY: 'auto' }}>
                      {mockSOPRules.map(rule => {
                        const categoryColors = {
                          'Netting': { bg: colors.secondaryLight, border: colors.secondary, text: colors.secondary },
                          'Bad Debt': { bg: colors.errorLight, border: colors.error, text: colors.error },
                          'Small Balance': { bg: colors.warningLight, border: colors.warning, text: '#E65100' },
                          'Short Payment': { bg: colors.purpleLight, border: colors.purple, text: colors.purple },
                          'Overpayment': { bg: colors.tealLight, border: colors.teal, text: colors.teal },
                          'Dimension Integrity': { bg: colors.background, border: colors.slateLight, text: colors.slate },
                          'Intercompany': { bg: colors.secondaryLight, border: colors.secondary, text: colors.secondary },
                        };
                        const cat = categoryColors[rule.category] || categoryColors['Dimension Integrity'];

                        return (
                          <div key={rule.id} style={{ padding: '16px', border: `1px solid ${colors.border}`, borderRadius: '8px', borderLeft: `4px solid ${cat.border}` }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '10px' }}>
                              <div>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '4px' }}>
                                  <Badge variant={rule.category === 'Netting' ? 'blueLight' : rule.category === 'Bad Debt' ? 'errorLight' : rule.category === 'Small Balance' ? 'warningLight' : rule.category === 'Short Payment' ? 'purpleLight' : rule.category === 'Overpayment' ? 'tealLight' : 'default'} size="sm">
                                    {rule.category}
                                  </Badge>
                                  {rule.approvalRequired && <Badge variant="warningLight" size="sm">Approval Required</Badge>}
                                  {rule.escalateTo && <Badge variant="errorLight" size="sm">Escalate: {rule.escalateTo}</Badge>}
                                </div>
                                <div style={{ fontWeight: 600, color: colors.slate, fontSize: '14px' }}>{rule.name}</div>
                              </div>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                <div style={{ width: '8px', height: '8px', borderRadius: '4px', backgroundColor: rule.enabled ? colors.primary : colors.slateLight }} />
                                <span style={{ fontSize: '11px', color: rule.enabled ? colors.primary : colors.slateLight }}>{rule.enabled ? 'Active' : 'Disabled'}</span>
                              </div>
                            </div>

                            <div style={{ marginBottom: '10px' }}>
                              <div style={{ fontSize: '11px', fontWeight: 600, color: colors.slateLight, textTransform: 'uppercase', marginBottom: '4px' }}>Conditions</div>
                              <ul style={{ margin: 0, paddingLeft: '16px', fontSize: '12px', color: colors.slate, lineHeight: 1.6 }}>
                                {rule.conditions.map((cond, i) => (
                                  <li key={i} style={{ marginBottom: '2px' }}>{cond}</li>
                                ))}
                              </ul>
                            </div>

                            <div style={{ marginBottom: '10px' }}>
                              <div style={{ fontSize: '11px', fontWeight: 600, color: colors.slateLight, textTransform: 'uppercase', marginBottom: '4px' }}>Action</div>
                              <div style={{ fontSize: '12px', color: colors.slate, backgroundColor: colors.background, padding: '8px 10px', borderRadius: '4px' }}>
                                {rule.action}
                              </div>
                            </div>

                            {rule.glAccounts && (
                              <div style={{ marginBottom: '10px' }}>
                                <div style={{ fontSize: '11px', fontWeight: 600, color: colors.slateLight, textTransform: 'uppercase', marginBottom: '4px' }}>GL Mapping</div>
                                <div style={{ fontSize: '12px', color: colors.slate, display: 'flex', gap: '16px', flexWrap: 'wrap' }}>
                                  {rule.glAccounts.debit && <span><strong>Dr:</strong> {rule.glAccounts.debit}</span>}
                                  {rule.glAccounts.credit && <span><strong>Cr:</strong> {rule.glAccounts.credit}</span>}
                                </div>
                              </div>
                            )}

                            <div style={{ fontSize: '11px', color: colors.slateLight, display: 'flex', gap: '12px', borderTop: `1px solid ${colors.border}`, paddingTop: '8px', marginTop: '8px' }}>
                              <span>Last modified: {rule.lastModified}</span>
                              <span>By: {rule.modifiedBy}</span>
                              <span>Priority: {rule.priority}</span>
                            </div>
                          </div>
                        );
                      })}
                    </div>

                    <div style={{ padding: '12px 14px', backgroundColor: colors.secondaryLight, borderRadius: '8px', marginBottom: '20px', display: 'flex', alignItems: 'flex-start', gap: '10px' }}>
                      <Icon name="info" size={18} color={colors.secondary} />
                      <div>
                        <div style={{ fontWeight: 600, color: colors.secondary, fontSize: '13px' }}>8 Active Rules Loaded</div>
                        <div style={{ fontSize: '12px', color: colors.secondary }}>These rules will be applied during the Adjustment phase. To modify, update the source SOP document.</div>
                      </div>
                    </div>

                    <div style={{ display: 'flex', gap: '12px' }}>
                      <Button variant="secondary" onClick={() => setSetupStep(3)}>Back</Button>
                      <Button variant="secondary" iconName="edit">Edit Rules</Button>
                      <Button onClick={() => setSetupStep(5)}>Confirm Rules & Continue</Button>
                    </div>
                  </Card>
                )}

                {/* Step 5: Asset Validation */}
                {setupStep === 5 && (
                  <Card>
                    <h3 style={{ fontSize: '16px', fontWeight: 600, color: colors.slate, marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <Icon name="layers" size={18} color={colors.secondary} /> Asset Readiness Validation
                    </h3>
                    <p style={{ fontSize: '13px', color: colors.slateLight, marginBottom: '16px' }}>Verify required connectors and external data sources</p>

                    {/* Connected Sources */}
                    <div style={{ marginBottom: '20px' }}>
                      <div style={{ fontSize: '11px', fontWeight: 600, color: colors.slateLight, textTransform: 'uppercase', marginBottom: '8px' }}>Connected Sources</div>
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                        {mockAssets.filter(a => a.status === 'connected').map(asset => (
                          <div key={asset.id} style={{ padding: '12px 14px', border: `1px solid ${colors.primary}`, borderRadius: '8px', display: 'flex', justifyContent: 'space-between', alignItems: 'center', backgroundColor: colors.primaryLight }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                              <Icon name="zap" size={18} color={colors.primary} />
                              <div>
                                <div style={{ fontWeight: 500, color: colors.slate }}>{asset.name}</div>
                                <div style={{ fontSize: '11px', color: colors.slateLight }}>{asset.description || 'API Connector'}</div>
                              </div>
                            </div>
                            <Badge variant="successLight" size="sm"><Icon name="check-circle" size={10} /> Connected</Badge>
                          </div>
                        ))}
                      </div>
                    </div>

                    {/* Transaction Spreadsheet Upload Section */}
                    <div style={{ marginBottom: '20px' }}>
                      <div style={{ fontSize: '11px', fontWeight: 600, color: colors.slateLight, textTransform: 'uppercase', marginBottom: '8px' }}>Transaction Spreadsheet Upload</div>

                      {uploadState === 'idle' && (
                        <div
                          onClick={simulateUpload}
                          onDragOver={(e) => { e.preventDefault(); setUploadState('dragging'); }}
                          onDragLeave={() => setUploadState('idle')}
                          onDrop={(e) => { e.preventDefault(); simulateUpload(); }}
                          style={{
                            padding: '32px',
                            border: `2px dashed ${colors.border}`,
                            borderRadius: '12px',
                            textAlign: 'center',
                            cursor: 'pointer',
                            backgroundColor: colors.white,
                            transition: 'all 0.2s ease'
                          }}
                        >
                          <div style={{ width: '48px', height: '48px', borderRadius: '12px', backgroundColor: colors.secondaryLight, display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto 12px' }}>
                            <Icon name="upload" size={24} color={colors.secondary} />
                          </div>
                          <div style={{ fontWeight: 600, color: colors.slate, marginBottom: '4px' }}>Drop your transaction spreadsheet here</div>
                          <div style={{ fontSize: '12px', color: colors.slateLight, marginBottom: '12px' }}>or click to browse • Supports .xlsx, .xls, .csv</div>
                          <div style={{ fontSize: '11px', color: colors.slateLight, padding: '8px', backgroundColor: colors.background, borderRadius: '6px', display: 'inline-block' }}>
                            Expected columns: Date, Type, Reference, Customer, Amount, Balance
                          </div>
                        </div>
                      )}

                      {uploadState === 'dragging' && (
                        <div
                          onDragOver={(e) => e.preventDefault()}
                          onDragLeave={() => setUploadState('idle')}
                          onDrop={(e) => { e.preventDefault(); simulateUpload(); }}
                          style={{
                            padding: '32px',
                            border: `2px dashed ${colors.primary}`,
                            borderRadius: '12px',
                            textAlign: 'center',
                            backgroundColor: colors.primaryLight,
                          }}
                        >
                          <div style={{ width: '48px', height: '48px', borderRadius: '12px', backgroundColor: colors.primary, display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto 12px' }}>
                            <Icon name="upload" size={24} color={colors.white} />
                          </div>
                          <div style={{ fontWeight: 600, color: colors.primaryDark, fontSize: '16px' }}>Drop to upload</div>
                        </div>
                      )}

                      {uploadState === 'uploading' && (
                        <div style={{ padding: '24px', border: `1px solid ${colors.border}`, borderRadius: '12px', backgroundColor: colors.white }}>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '16px' }}>
                            <div style={{ width: '40px', height: '40px', borderRadius: '8px', backgroundColor: colors.secondaryLight, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                              <Icon name="file-text" size={20} color={colors.secondary} />
                            </div>
                            <div style={{ flex: 1 }}>
                              <div style={{ fontWeight: 500, color: colors.slate }}>Jan_2024_AR_Transactions.xlsx</div>
                              <div style={{ fontSize: '11px', color: colors.slateLight }}>Uploading...</div>
                            </div>
                            <div style={{ fontSize: '14px', fontWeight: 600, color: colors.secondary }}>{Math.min(100, Math.round(uploadProgress))}%</div>
                          </div>
                          <div style={{ height: '8px', backgroundColor: colors.border, borderRadius: '4px', overflow: 'hidden' }}>
                            <div style={{ height: '100%', width: `${Math.min(100, uploadProgress)}%`, backgroundColor: colors.secondary, borderRadius: '4px', transition: 'width 0.2s ease' }} />
                          </div>
                        </div>
                      )}

                      {uploadState === 'parsing' && (
                        <div style={{ padding: '24px', border: `1px solid ${colors.border}`, borderRadius: '12px', backgroundColor: colors.white }}>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                            <div style={{ width: '40px', height: '40px', borderRadius: '8px', backgroundColor: colors.purpleLight, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                              <Icon name="loader" size={20} color={colors.purple} className="animate-spin" />
                            </div>
                            <div style={{ flex: 1 }}>
                              <div style={{ fontWeight: 500, color: colors.slate }}>Jan_2024_AR_Transactions.xlsx</div>
                              <div style={{ fontSize: '11px', color: colors.purple, display: 'flex', alignItems: 'center', gap: '4px' }}>
                                <span className="animate-pulse">Parsing spreadsheet and validating data...</span>
                              </div>
                            </div>
                          </div>
                        </div>
                      )}

                      {uploadState === 'complete' && uploadedFile && (
                        <div style={{ padding: '20px', border: `2px solid ${colors.primary}`, borderRadius: '12px', backgroundColor: colors.primaryLight }}>
                          <div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>
                            <div style={{ width: '44px', height: '44px', borderRadius: '10px', backgroundColor: colors.primary, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                              <Icon name="check-circle" size={24} color={colors.white} />
                            </div>
                            <div style={{ flex: 1 }}>
                              <div style={{ fontWeight: 600, color: colors.primaryDark, marginBottom: '4px' }}>{uploadedFile.name}</div>
                              <div style={{ fontSize: '12px', color: colors.slateLight, marginBottom: '12px' }}>{uploadedFile.size} • Uploaded successfully</div>

                              <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap', marginBottom: '12px' }}>
                                <div style={{ padding: '8px 12px', backgroundColor: colors.white, borderRadius: '6px', border: `1px solid ${colors.border}` }}>
                                  <div style={{ fontSize: '18px', fontWeight: 700, color: colors.primary }}>{uploadedFile.records}</div>
                                  <div style={{ fontSize: '10px', color: colors.slateLight }}>Records Found</div>
                                </div>
                                <div style={{ padding: '8px 12px', backgroundColor: colors.white, borderRadius: '6px', border: `1px solid ${colors.border}` }}>
                                  <div style={{ fontSize: '18px', fontWeight: 700, color: colors.secondary }}>{uploadedFile.sheets.length}</div>
                                  <div style={{ fontSize: '10px', color: colors.slateLight }}>Sheets Detected</div>
                                </div>
                              </div>

                              <div style={{ fontSize: '11px', color: colors.slateLight }}>
                                <strong>Sheets:</strong> {uploadedFile.sheets.join(', ')}
                              </div>
                            </div>
                            <button onClick={() => { setUploadState('idle'); setUploadedFile(null); }} style={{ padding: '4px 8px', fontSize: '11px', color: colors.slateLight, backgroundColor: 'transparent', border: 'none', cursor: 'pointer' }}>
                              Replace
                            </button>
                          </div>
                        </div>
                      )}
                    </div>

                    {/* Other Uploads */}
                    <div style={{ marginBottom: '20px' }}>
                      <div style={{ fontSize: '11px', fontWeight: 600, color: colors.slateLight, textTransform: 'uppercase', marginBottom: '8px' }}>Additional Files (Optional)</div>
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                        {mockAssets.filter(a => a.type === 'upload' && a.id !== 'asset_4').slice(1).map(asset => (
                          <div key={asset.id} style={{ padding: '12px 14px', border: `1px solid ${colors.border}`, borderRadius: '8px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                              <Icon name="upload" size={18} color={asset.status === 'uploaded' ? colors.primary : colors.slateLight} />
                              <div>
                                <div style={{ fontWeight: 500, color: colors.slate }}>{asset.name}</div>
                                <div style={{ fontSize: '11px', color: colors.slateLight }}>File Upload • {asset.required ? 'Required' : 'Optional'}</div>
                              </div>
                            </div>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                              {asset.status === 'uploaded' && <Badge variant="successLight" size="sm"><Icon name="check-circle" size={10} /> Uploaded</Badge>}
                              {asset.status === 'optional' && <Button size="sm" variant="secondary" iconName="upload">Upload</Button>}
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>

                    {/* Status Summary */}
                    {uploadState === 'complete' ? (
                      <div style={{ padding: '12px 14px', backgroundColor: colors.primaryLight, borderRadius: '8px', marginBottom: '20px', display: 'flex', alignItems: 'center', gap: '10px' }}>
                        <Icon name="check-circle" size={18} color={colors.primary} />
                        <div>
                          <div style={{ fontWeight: 600, color: colors.primaryDark, fontSize: '13px' }}>All Required Assets Ready</div>
                          <div style={{ fontSize: '12px', color: colors.slateLight }}>3 connectors active, 1 spreadsheet uploaded ({uploadedFile?.records} records)</div>
                        </div>
                      </div>
                    ) : (
                      <div style={{ padding: '12px 14px', backgroundColor: colors.warningLight, borderRadius: '8px', marginBottom: '20px', display: 'flex', alignItems: 'flex-start', gap: '10px' }}>
                        <Icon name="alert-triangle" size={18} color={colors.warning} />
                        <div>
                          <div style={{ fontWeight: 600, color: '#E65100', fontSize: '13px' }}>Transaction Spreadsheet Required</div>
                          <div style={{ fontSize: '12px', color: '#E65100' }}>Upload your AR transaction register to enable full reconciliation</div>
                        </div>
                      </div>
                    )}

                    <div style={{ display: 'flex', gap: '12px' }}>
                      <Button variant="secondary" onClick={() => setSetupStep(4)}>Back</Button>
                      <Button onClick={() => setSetupStep(6)} disabled={uploadState !== 'complete'} iconName={uploadState === 'complete' ? 'check' : undefined}>
                        {uploadState === 'complete' ? 'Continue' : 'Upload Required File to Continue'}
                      </Button>
                    </div>
                  </Card>
                )}

                {/* Step 6: Execution Plan */}
                {setupStep === 6 && (
                  <Card>
                    <h3 style={{ fontSize: '16px', fontWeight: 600, color: colors.slate, marginBottom: '4px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <Icon name="clipboard" size={18} color={colors.secondary} /> Execution Plan
                    </h3>
                    <p style={{ fontSize: '13px', color: colors.slateLight, marginBottom: '16px' }}>Review and approve the step-by-step run plan</p>

                    <div style={{ marginBottom: '16px' }}>
                      <div style={{ display: 'flex', gap: '8px', marginBottom: '12px', flexWrap: 'wrap' }}>
                        <Badge variant="tealLight">Auto</Badge>
                        <Badge variant="blueLight">Draft+Confirm</Badge>
                        <Badge variant="warningLight">Ask User</Badge>
                        <Badge variant="errorLight">Escalate</Badge>
                      </div>
                    </div>

                    <div style={{ border: `1px solid ${colors.border}`, borderRadius: '8px', overflow: 'hidden', marginBottom: '20px' }}>
                      <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '13px' }}>
                        <thead>
                          <tr style={{ backgroundColor: colors.background }}>
                            <th style={{ padding: '10px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, fontSize: '11px', textTransform: 'uppercase' }}>#</th>
                            <th style={{ padding: '10px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, fontSize: '11px', textTransform: 'uppercase' }}>Step</th>
                            <th style={{ padding: '10px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, fontSize: '11px', textTransform: 'uppercase' }}>Lane</th>
                            <th style={{ padding: '10px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, fontSize: '11px', textTransform: 'uppercase' }}>Inputs</th>
                            <th style={{ padding: '10px 12px', textAlign: 'center', fontWeight: 600, color: colors.slateLight, fontSize: '11px', textTransform: 'uppercase' }}>Edit</th>
                          </tr>
                        </thead>
                        <tbody>
                          {mockExecutionPlan.map((step, i) => (
                            <tr key={step.id} style={{ borderTop: `1px solid ${colors.border}` }}>
                              <td style={{ padding: '10px 12px', color: colors.slateLight }}>{step.id}</td>
                              <td style={{ padding: '10px 12px', color: colors.slate, fontWeight: 500 }}>{step.step}</td>
                              <td style={{ padding: '10px 12px' }}><Badge variant={laneColors[step.lane]} size="sm">{step.lane}</Badge></td>
                              <td style={{ padding: '10px 12px', color: colors.slateLight, fontSize: '12px' }}>{step.inputs}</td>
                              <td style={{ padding: '10px 12px', textAlign: 'center' }}><Button variant="ghost" size="sm" iconName="edit" /></td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>

                    <div style={{ display: 'flex', gap: '12px' }}>
                      <Button variant="secondary" onClick={() => setSetupStep(5)}>Back</Button>
                      <Button onClick={() => { setPlanApproved(true); setPhase('data_pull'); }} iconName="check">Approve Plan & Start Run</Button>
                    </div>
                  </Card>
                )}
              </div>
            )}

            {/* DATA PULL PHASE */}
            {phase === 'data_pull' && (
              <div style={{ maxWidth: '1000px' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                  <div>
                    <h1 style={{ fontSize: '24px', fontWeight: 700, color: colors.slate, marginBottom: '4px' }}>AR State Map</h1>
                    <p style={{ fontSize: '14px', color: colors.slateLight }}>Frozen snapshot of all AR data as of {closeDate}</p>
                  </div>
                  <Badge variant="successLight"><Icon name="lock" size={12} /> Evidence Locked</Badge>
                </div>

                {/* Key Metrics */}
                <div style={{ display: 'flex', gap: '12px', marginBottom: '24px', flexWrap: 'wrap' }}>
                  <StatCard icon="dollar-sign" label="GL AR Balance" value={fmt(156750)} subValue="Trial Balance" color={colors.secondary} />
                  <StatCard icon="file-text" label="AR Aging Total" value={fmt(156750)} subValue="47 invoices" color={colors.purple} />
                  <StatCard icon="credit-card" label="Unapplied Cash" value={fmt(21200)} subValue="5 payments" color={colors.warning} />
                  <StatCard icon="zap" label="Ghost Cash" value={fmt(3000)} subValue="2 deposits" color={colors.error} />
                </div>

                {/* GL vs Aging Tie-Out Preview */}
                <Card style={{ marginBottom: '16px' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                    <h3 style={{ fontSize: '14px', fontWeight: 600, color: colors.slate, display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <Icon name="target" size={16} color={colors.secondary} /> GL to Sub-Ledger Comparison (Starting Point)
                    </h3>
                    <Badge variant="successLight">Balanced</Badge>
                  </div>

                  <div style={{ display: 'flex', gap: '16px', alignItems: 'center', flexWrap: 'wrap', marginBottom: '16px' }}>
                    <div style={{ flex: 1, minWidth: '200px', padding: '16px', backgroundColor: colors.secondaryLight, borderRadius: '8px', textAlign: 'center' }}>
                      <div style={{ fontSize: '11px', color: colors.secondary, marginBottom: '4px', textTransform: 'uppercase', fontWeight: 600 }}>GL Control (1200)</div>
                      <div style={{ fontSize: '24px', fontWeight: 700, color: colors.secondary }}>{fmt(156750)}</div>
                    </div>
                    <div style={{ fontSize: '20px', color: colors.slateLight }}>=</div>
                    <div style={{ flex: 1, minWidth: '200px', padding: '16px', backgroundColor: colors.purpleLight, borderRadius: '8px', textAlign: 'center' }}>
                      <div style={{ fontSize: '11px', color: colors.purple, marginBottom: '4px', textTransform: 'uppercase', fontWeight: 600 }}>AR Aging Summary</div>
                      <div style={{ fontSize: '24px', fontWeight: 700, color: colors.purple }}>{fmt(156750)}</div>
                    </div>
                    <div style={{ fontSize: '20px', color: colors.slateLight }}>→</div>
                    <div style={{ flex: 1, minWidth: '200px', padding: '16px', backgroundColor: colors.primaryLight, borderRadius: '8px', textAlign: 'center' }}>
                      <div style={{ fontSize: '11px', color: colors.primaryDark, marginBottom: '4px', textTransform: 'uppercase', fontWeight: 600 }}>Variance</div>
                      <div style={{ fontSize: '24px', fontWeight: 700, color: colors.primary }}>{fmt(0)}</div>
                    </div>
                  </div>

                  {/* Report Links */}
                  <div style={{ display: 'flex', gap: '12px', marginBottom: '16px', flexWrap: 'wrap' }}>
                    <a href="#" style={{ display: 'inline-flex', alignItems: 'center', gap: '6px', fontSize: '12px', color: colors.secondary, textDecoration: 'none', padding: '6px 12px', backgroundColor: colors.secondaryLight, borderRadius: '4px' }}>
                      <Icon name="file-text" size={14} /> View Trial Balance
                    </a>
                    <a href="#" style={{ display: 'inline-flex', alignItems: 'center', gap: '6px', fontSize: '12px', color: colors.secondary, textDecoration: 'none', padding: '6px 12px', backgroundColor: colors.secondaryLight, borderRadius: '4px' }}>
                      <Icon name="file-text" size={14} /> View AR Aging Summary
                    </a>
                    <a href="#" style={{ display: 'inline-flex', alignItems: 'center', gap: '6px', fontSize: '12px', color: colors.secondary, textDecoration: 'none', padding: '6px 12px', backgroundColor: colors.secondaryLight, borderRadius: '4px' }}>
                      <Icon name="file-text" size={14} /> View AR Aging Detail
                    </a>
                  </div>

                  {/* Expandable Customer Breakdown */}
                  <div style={{ borderTop: `1px solid ${colors.border}`, paddingTop: '12px' }}>
                    <div onClick={() => toggleSection('tieoutCustomers')} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', cursor: 'pointer', marginBottom: expandedSections.tieoutCustomers ? '12px' : 0 }}>
                      <span style={{ fontSize: '13px', fontWeight: 500, color: colors.slate }}>View Balance by Customer</span>
                      <Icon name={expandedSections.tieoutCustomers ? 'chevron-down' : 'chevron-right'} size={18} color={colors.slateLight} />
                    </div>

                    {expandedSections.tieoutCustomers && (
                      <div style={{ border: `1px solid ${colors.border}`, borderRadius: '8px', overflow: 'hidden' }}>
                        <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '12px' }}>
                          <thead>
                            <tr style={{ backgroundColor: colors.background }}>
                              <th style={{ padding: '10px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, fontSize: '10px', textTransform: 'uppercase' }}>Customer</th>
                              <th style={{ padding: '10px', textAlign: 'right', fontWeight: 600, color: colors.slateLight, fontSize: '10px', textTransform: 'uppercase' }}>Current</th>
                              <th style={{ padding: '10px', textAlign: 'right', fontWeight: 600, color: colors.slateLight, fontSize: '10px', textTransform: 'uppercase' }}>1-30</th>
                              <th style={{ padding: '10px', textAlign: 'right', fontWeight: 600, color: colors.slateLight, fontSize: '10px', textTransform: 'uppercase' }}>31-60</th>
                              <th style={{ padding: '10px', textAlign: 'right', fontWeight: 600, color: colors.slateLight, fontSize: '10px', textTransform: 'uppercase' }}>61-90</th>
                              <th style={{ padding: '10px', textAlign: 'right', fontWeight: 600, color: colors.slateLight, fontSize: '10px', textTransform: 'uppercase' }}>90+</th>
                              <th style={{ padding: '10px', textAlign: 'right', fontWeight: 600, color: colors.slateLight, fontSize: '10px', textTransform: 'uppercase' }}>Total</th>
                            </tr>
                          </thead>
                          <tbody>
                            {[
                              { name: 'Acme Corp', current: 45000, d30: 6000, d60: 0, d90: 0, d90plus: 0 },
                              { name: 'TechStart LLC', current: 28500, d30: 2250, d60: 0, d90: 0, d90plus: 0 },
                              { name: 'Global Industries', current: 35750, d30: 0, d60: 3200, d90: 0, d90plus: 0 },
                              { name: 'Smith & Co', current: 12000, d30: 3200, d60: 0, d90: 0, d90plus: 0 },
                              { name: 'Beta Holdings', current: 8500, d30: 1050, d60: 3000, d90: 950, d90plus: 0 },
                              { name: 'Old Client Inc', current: 0, d30: 0, d60: 0, d90: 1225, d90plus: 1125 },
                              { name: 'NewCo Inc', current: 5000, d30: 0, d60: 0, d90: 0, d90plus: 0 },
                            ].map((cust, i) => {
                              const total = cust.current + cust.d30 + cust.d60 + cust.d90 + cust.d90plus;
                              return (
                                <tr key={i} style={{ borderTop: `1px solid ${colors.border}` }}>
                                  <td style={{ padding: '10px', fontWeight: 500, color: colors.slate }}>{cust.name}</td>
                                  <td style={{ padding: '10px', textAlign: 'right', color: colors.slate }}>{cust.current > 0 ? fmt(cust.current) : '-'}</td>
                                  <td style={{ padding: '10px', textAlign: 'right', color: cust.d30 > 0 ? colors.secondary : colors.slateLight }}>{cust.d30 > 0 ? fmt(cust.d30) : '-'}</td>
                                  <td style={{ padding: '10px', textAlign: 'right', color: cust.d60 > 0 ? colors.warning : colors.slateLight }}>{cust.d60 > 0 ? fmt(cust.d60) : '-'}</td>
                                  <td style={{ padding: '10px', textAlign: 'right', color: cust.d90 > 0 ? '#FF6D00' : colors.slateLight }}>{cust.d90 > 0 ? fmt(cust.d90) : '-'}</td>
                                  <td style={{ padding: '10px', textAlign: 'right', color: cust.d90plus > 0 ? colors.error : colors.slateLight }}>{cust.d90plus > 0 ? fmt(cust.d90plus) : '-'}</td>
                                  <td style={{ padding: '10px', textAlign: 'right', fontWeight: 600, color: colors.slate }}>{fmt(total)}</td>
                                </tr>
                              );
                            })}
                            <tr style={{ borderTop: `2px solid ${colors.border}`, backgroundColor: colors.background }}>
                              <td style={{ padding: '10px', fontWeight: 700, color: colors.slate }}>TOTAL</td>
                              <td style={{ padding: '10px', textAlign: 'right', fontWeight: 700, color: colors.slate }}>{fmt(134750)}</td>
                              <td style={{ padding: '10px', textAlign: 'right', fontWeight: 700, color: colors.secondary }}>{fmt(12500)}</td>
                              <td style={{ padding: '10px', textAlign: 'right', fontWeight: 700, color: colors.warning }}>{fmt(6200)}</td>
                              <td style={{ padding: '10px', textAlign: 'right', fontWeight: 700, color: '#FF6D00' }}>{fmt(2175)}</td>
                              <td style={{ padding: '10px', textAlign: 'right', fontWeight: 700, color: colors.error }}>{fmt(1125)}</td>
                              <td style={{ padding: '10px', textAlign: 'right', fontWeight: 700, color: colors.primary }}>{fmt(156750)}</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    )}
                  </div>
                </Card>

                {/* Aging Breakdown */}
                <Card style={{ marginBottom: '16px' }}>
                  <h3 style={{ fontSize: '14px', fontWeight: 600, color: colors.slate, marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                    <Icon name="bar-chart" size={16} color={colors.secondary} /> AR Aging Breakdown
                  </h3>
                  <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                    {[
                      { label: 'Current', amount: 134750, count: 38, color: colors.primary },
                      { label: '1-30 Days', amount: 12500, count: 5, color: colors.secondary },
                      { label: '31-60 Days', amount: 6200, count: 2, color: colors.warning },
                      { label: '61-90 Days', amount: 2175, count: 1, color: '#FF6D00' },
                      { label: '90+ Days', amount: 1125, count: 1, color: colors.error },
                    ].map((bucket, i) => (
                      <div key={i} style={{ flex: 1, minWidth: '140px', padding: '12px', border: `1px solid ${colors.border}`, borderRadius: '8px', borderTop: `3px solid ${bucket.color}` }}>
                        <div style={{ fontSize: '11px', color: colors.slateLight, marginBottom: '4px' }}>{bucket.label}</div>
                        <div style={{ fontSize: '18px', fontWeight: 700, color: colors.slate }}>{fmt(bucket.amount)}</div>
                        <div style={{ fontSize: '11px', color: colors.slateLight }}>{bucket.count} invoices</div>
                      </div>
                    ))}
                  </div>
                </Card>

                {/* QBO vs External Billing Gap */}
                <Card style={{ marginBottom: '16px', border: `1px solid ${colors.warning}` }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                    <h3 style={{ fontSize: '14px', fontWeight: 600, color: colors.slate, display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <Icon name="alert-triangle" size={16} color={colors.warning} /> Invoice Gap: QBO vs External Sources
                    </h3>
                    <Badge variant="warningLight">2 Discrepancies Found</Badge>
                  </div>

                  <div style={{ display: 'flex', gap: '16px', marginBottom: '16px', flexWrap: 'wrap' }}>
                    <div style={{ flex: 1, minWidth: '180px', padding: '12px', backgroundColor: colors.background, borderRadius: '8px' }}>
                      <div style={{ fontSize: '11px', color: colors.slateLight, marginBottom: '4px' }}>QBO Invoices (Jan)</div>
                      <div style={{ fontSize: '20px', fontWeight: 700, color: colors.slate }}>47</div>
                      <div style={{ fontSize: '12px', color: colors.slateLight }}>{fmt(156750)}</div>
                    </div>
                    <div style={{ flex: 1, minWidth: '180px', padding: '12px', backgroundColor: colors.background, borderRadius: '8px' }}>
                      <div style={{ fontSize: '11px', color: colors.slateLight, marginBottom: '4px' }}>Stripe Billing Register</div>
                      <div style={{ fontSize: '20px', fontWeight: 700, color: colors.slate }}>52</div>
                      <div style={{ fontSize: '12px', color: colors.slateLight }}>{fmt(162500)}</div>
                    </div>
                    <div style={{ flex: 1, minWidth: '180px', padding: '12px', backgroundColor: colors.warningLight, borderRadius: '8px' }}>
                      <div style={{ fontSize: '11px', color: '#E65100', marginBottom: '4px' }}>Missing in QBO</div>
                      <div style={{ fontSize: '20px', fontWeight: 700, color: '#E65100' }}>2</div>
                      <div style={{ fontSize: '12px', color: '#E65100' }}>{fmt(2250)} revenue at risk</div>
                    </div>
                  </div>

                  {/* Report Links */}
                  <div style={{ display: 'flex', gap: '12px', marginBottom: '16px', flexWrap: 'wrap' }}>
                    <a href="#" style={{ display: 'inline-flex', alignItems: 'center', gap: '6px', fontSize: '12px', color: colors.secondary, textDecoration: 'none', padding: '6px 12px', backgroundColor: colors.secondaryLight, borderRadius: '4px' }}>
                      <Icon name="file-text" size={14} /> View AR Aging Summary
                    </a>
                    <a href="#" style={{ display: 'inline-flex', alignItems: 'center', gap: '6px', fontSize: '12px', color: colors.secondary, textDecoration: 'none', padding: '6px 12px', backgroundColor: colors.secondaryLight, borderRadius: '4px' }}>
                      <Icon name="file-text" size={14} /> View AR Aging Detail
                    </a>
                    <a href="#" style={{ display: 'inline-flex', alignItems: 'center', gap: '6px', fontSize: '12px', color: colors.secondary, textDecoration: 'none', padding: '6px 12px', backgroundColor: colors.secondaryLight, borderRadius: '4px' }}>
                      <Icon name="external-link" size={14} /> View Stripe Billing Register
                    </a>
                  </div>

                  {/* Expandable Customer Comparison */}
                  <div style={{ borderTop: `1px solid ${colors.border}`, paddingTop: '12px' }}>
                    <div onClick={() => toggleSection('gapCustomers')} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', cursor: 'pointer', marginBottom: expandedSections.gapCustomers ? '12px' : 0 }}>
                      <span style={{ fontSize: '13px', fontWeight: 500, color: colors.slate }}>View Comparison by Customer</span>
                      <Icon name={expandedSections.gapCustomers ? 'chevron-down' : 'chevron-right'} size={18} color={colors.slateLight} />
                    </div>

                    {expandedSections.gapCustomers && (
                      <div style={{ border: `1px solid ${colors.border}`, borderRadius: '8px', overflow: 'hidden' }}>
                        <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '12px' }}>
                          <thead>
                            <tr style={{ backgroundColor: colors.background }}>
                              <th style={{ padding: '10px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, fontSize: '10px', textTransform: 'uppercase' }}>Customer</th>
                              <th style={{ padding: '10px', textAlign: 'right', fontWeight: 600, color: colors.slateLight, fontSize: '10px', textTransform: 'uppercase' }}>QBO Invoices</th>
                              <th style={{ padding: '10px', textAlign: 'right', fontWeight: 600, color: colors.slateLight, fontSize: '10px', textTransform: 'uppercase' }}>QBO Amount</th>
                              <th style={{ padding: '10px', textAlign: 'right', fontWeight: 600, color: colors.slateLight, fontSize: '10px', textTransform: 'uppercase' }}>Stripe Charges</th>
                              <th style={{ padding: '10px', textAlign: 'right', fontWeight: 600, color: colors.slateLight, fontSize: '10px', textTransform: 'uppercase' }}>Stripe Amount</th>
                              <th style={{ padding: '10px', textAlign: 'right', fontWeight: 600, color: colors.slateLight, fontSize: '10px', textTransform: 'uppercase' }}>Variance</th>
                              <th style={{ padding: '10px', textAlign: 'center', fontWeight: 600, color: colors.slateLight, fontSize: '10px', textTransform: 'uppercase' }}>Status</th>
                            </tr>
                          </thead>
                          <tbody>
                            {[
                              { name: 'Acme Corp', qboCount: 8, qboAmt: 51000, stripeCount: 8, stripeAmt: 51000, status: 'matched' },
                              { name: 'TechStart LLC', qboCount: 6, qboAmt: 30750, stripeCount: 6, stripeAmt: 30750, status: 'matched' },
                              { name: 'Global Industries', qboCount: 5, qboAmt: 38950, stripeCount: 5, stripeAmt: 38950, status: 'matched' },
                              { name: 'Smith & Co', qboCount: 4, qboAmt: 15200, stripeCount: 4, stripeAmt: 15200, status: 'matched' },
                              { name: 'Beta Holdings', qboCount: 3, qboAmt: 13500, stripeCount: 3, stripeAmt: 13500, status: 'matched' },
                              { name: 'NewCo Inc', qboCount: 0, qboAmt: 0, stripeCount: 1, stripeAmt: 1500, status: 'missing_qbo' },
                              { name: 'FastGrow LLC', qboCount: 0, qboAmt: 0, stripeCount: 1, stripeAmt: 750, status: 'missing_qbo' },
                              { name: 'Old Client Inc', qboCount: 2, qboAmt: 2350, stripeCount: 2, stripeAmt: 2350, status: 'matched' },
                              { name: 'Other Customers', qboCount: 19, qboAmt: 5000, stripeCount: 22, stripeAmt: 8500, status: 'review' },
                            ].map((cust, i) => {
                              const variance = cust.stripeAmt - cust.qboAmt;
                              return (
                                <tr key={i} style={{ borderTop: `1px solid ${colors.border}`, backgroundColor: cust.status === 'missing_qbo' ? colors.warningLight : 'transparent' }}>
                                  <td style={{ padding: '10px', fontWeight: 500, color: colors.slate }}>{cust.name}</td>
                                  <td style={{ padding: '10px', textAlign: 'right', color: colors.slate }}>{cust.qboCount}</td>
                                  <td style={{ padding: '10px', textAlign: 'right', color: colors.slate }}>{fmt(cust.qboAmt)}</td>
                                  <td style={{ padding: '10px', textAlign: 'right', color: colors.slate }}>{cust.stripeCount}</td>
                                  <td style={{ padding: '10px', textAlign: 'right', color: colors.slate }}>{fmt(cust.stripeAmt)}</td>
                                  <td style={{ padding: '10px', textAlign: 'right', fontWeight: 600, color: variance === 0 ? colors.primary : colors.error }}>
                                    {variance === 0 ? '-' : fmt(variance)}
                                  </td>
                                  <td style={{ padding: '10px', textAlign: 'center' }}>
                                    <Badge variant={cust.status === 'matched' ? 'successLight' : cust.status === 'missing_qbo' ? 'errorLight' : 'warningLight'} size="sm">
                                      {cust.status === 'matched' ? 'Matched' : cust.status === 'missing_qbo' ? 'Missing in QBO' : 'Review'}
                                    </Badge>
                                  </td>
                                </tr>
                              );
                            })}
                            <tr style={{ borderTop: `2px solid ${colors.border}`, backgroundColor: colors.background }}>
                              <td style={{ padding: '10px', fontWeight: 700, color: colors.slate }}>TOTAL</td>
                              <td style={{ padding: '10px', textAlign: 'right', fontWeight: 700, color: colors.slate }}>47</td>
                              <td style={{ padding: '10px', textAlign: 'right', fontWeight: 700, color: colors.slate }}>{fmt(156750)}</td>
                              <td style={{ padding: '10px', textAlign: 'right', fontWeight: 700, color: colors.slate }}>52</td>
                              <td style={{ padding: '10px', textAlign: 'right', fontWeight: 700, color: colors.slate }}>{fmt(162500)}</td>
                              <td style={{ padding: '10px', textAlign: 'right', fontWeight: 700, color: colors.error }}>{fmt(5750)}</td>
                              <td style={{ padding: '10px' }}></td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    )}
                  </div>

                  {/* Missing Invoice Details */}
                  <div style={{ borderTop: `1px solid ${colors.border}`, paddingTop: '12px', marginTop: '12px' }}>
                    <div onClick={() => toggleSection('missingInvoices')} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', cursor: 'pointer', marginBottom: expandedSections.missingInvoices ? '12px' : 0 }}>
                      <span style={{ fontSize: '13px', fontWeight: 500, color: colors.error }}>View Missing Invoice Details (2)</span>
                      <Icon name={expandedSections.missingInvoices ? 'chevron-down' : 'chevron-right'} size={18} color={colors.slateLight} />
                    </div>

                    {expandedSections.missingInvoices && (
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                        {[
                          { stripeId: 'STRIPE-8821', customer: 'NewCo Inc', date: '2024-01-28', amount: 1500, description: 'Enterprise Plan - Monthly', email: 'billing@newco.com' },
                          { stripeId: 'STRIPE-8834', customer: 'FastGrow LLC', date: '2024-01-29', amount: 750, description: 'Starter Plan - Monthly', email: 'ap@fastgrow.io' },
                        ].map((inv, i) => (
                          <div key={i} style={{ padding: '12px', backgroundColor: colors.errorLight, borderRadius: '8px', border: `1px solid ${colors.error}` }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '8px' }}>
                              <div>
                                <div style={{ fontWeight: 600, color: colors.slate, fontSize: '14px' }}>{inv.customer}</div>
                                <div style={{ fontSize: '12px', color: colors.slateLight }}>{inv.stripeId} • {inv.date}</div>
                              </div>
                              <div style={{ fontWeight: 700, color: colors.error, fontSize: '16px' }}>{fmt(inv.amount)}</div>
                            </div>
                            <div style={{ fontSize: '12px', color: colors.slate, marginBottom: '4px' }}><strong>Description:</strong> {inv.description}</div>
                            <div style={{ fontSize: '12px', color: colors.slateLight }}><strong>Customer Email:</strong> {inv.email}</div>
                            <div style={{ marginTop: '8px', padding: '8px', backgroundColor: colors.white, borderRadius: '4px', fontSize: '11px', color: colors.error }}>
                              <Icon name="alert-triangle" size={12} style={{ marginRight: '4px' }} />
                              This charge exists in Stripe but has no matching invoice in QBO. Will be flagged for invoice creation in Gap Analysis.
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </Card>

                {/* Gmail Parsed Invoices Gap */}
                <Card style={{ marginBottom: '16px', border: `1px solid ${colors.warning}` }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                    <h3 style={{ fontSize: '14px', fontWeight: 600, color: colors.slate, display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <Icon name="mail" size={16} color={colors.warning} /> Gmail: Invoices Not in QBO
                    </h3>
                    <Badge variant="warningLight">{mockGmailInvoices.filter(g => g.matchStatus === 'missing_in_qbo').length} Found</Badge>
                  </div>

                  <div style={{ display: 'flex', gap: '16px', marginBottom: '16px', flexWrap: 'wrap' }}>
                    <div style={{ flex: 1, minWidth: '160px', padding: '12px', backgroundColor: colors.background, borderRadius: '8px' }}>
                      <div style={{ fontSize: '11px', color: colors.slateLight, marginBottom: '4px' }}>Gmail Invoices Parsed</div>
                      <div style={{ fontSize: '20px', fontWeight: 700, color: colors.slate }}>{mockGmailInvoices.length}</div>
                      <div style={{ fontSize: '12px', color: colors.slateLight }}>from email attachments</div>
                    </div>
                    <div style={{ flex: 1, minWidth: '160px', padding: '12px', backgroundColor: colors.primaryLight, borderRadius: '8px' }}>
                      <div style={{ fontSize: '11px', color: colors.slateLight, marginBottom: '4px' }}>Matched to QBO</div>
                      <div style={{ fontSize: '20px', fontWeight: 700, color: colors.primary }}>{mockGmailInvoices.filter(g => g.matchStatus === 'matched').length}</div>
                      <div style={{ fontSize: '12px', color: colors.primary }}>invoices matched</div>
                    </div>
                    <div style={{ flex: 1, minWidth: '160px', padding: '12px', backgroundColor: colors.warningLight, borderRadius: '8px' }}>
                      <div style={{ fontSize: '11px', color: '#E65100', marginBottom: '4px' }}>Missing in QBO</div>
                      <div style={{ fontSize: '20px', fontWeight: 700, color: '#E65100' }}>{mockGmailInvoices.filter(g => g.matchStatus === 'missing_in_qbo').length}</div>
                      <div style={{ fontSize: '12px', color: '#E65100' }}>{fmt(mockGmailInvoices.filter(g => g.matchStatus === 'missing_in_qbo').reduce((sum, g) => sum + g.amount, 0))} at risk</div>
                    </div>
                  </div>

                  {/* Expandable Missing Invoice Details */}
                  <div style={{ borderTop: `1px solid ${colors.border}`, paddingTop: '12px' }}>
                    <div onClick={() => toggleSection('gmailMissingInvoices')} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', cursor: 'pointer', marginBottom: expandedSections.gmailMissingInvoices ? '12px' : 0 }}>
                      <span style={{ fontSize: '13px', fontWeight: 500, color: colors.warning }}>View Missing Invoice Details ({mockGmailInvoices.filter(g => g.matchStatus === 'missing_in_qbo').length})</span>
                      <Icon name={expandedSections.gmailMissingInvoices ? 'chevron-down' : 'chevron-right'} size={18} color={colors.slateLight} />
                    </div>

                    {expandedSections.gmailMissingInvoices && (
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                        {mockGmailInvoices.filter(g => g.matchStatus === 'missing_in_qbo').map((inv, i) => (
                          <div key={i} style={{ padding: '12px', backgroundColor: colors.warningLight, borderRadius: '8px', border: `1px solid ${colors.warning}` }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '8px' }}>
                              <div>
                                <div style={{ fontWeight: 600, color: colors.slate, fontSize: '14px' }}>{inv.customer}</div>
                                <div style={{ fontSize: '12px', color: colors.slateLight }}>{inv.id} • {inv.date}</div>
                              </div>
                              <div style={{ fontWeight: 700, color: colors.warning, fontSize: '16px' }}>{fmt(inv.amount)}</div>
                            </div>
                            <div style={{ fontSize: '12px', color: colors.slate, marginBottom: '4px' }}><strong>Subject:</strong> {inv.subject}</div>
                            <div style={{ fontSize: '12px', color: colors.slateLight, marginBottom: '4px' }}><strong>From:</strong> {inv.sender}</div>
                            <div style={{ fontSize: '12px', color: colors.slateLight }}><strong>Attachment:</strong> <a href="#" style={{ color: colors.secondary }}>{inv.attachmentName}</a></div>
                            <div style={{ marginTop: '8px', padding: '8px', backgroundColor: colors.white, borderRadius: '4px', fontSize: '11px', color: colors.warning }}>
                              <Icon name="alert-triangle" size={12} style={{ marginRight: '4px' }} />
                              This invoice attachment was found in Gmail but has no matching invoice in QBO. Will be flagged for invoice creation.
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>

                  {/* Gmail Payment Confirmations */}
                  {mockGmailPayments.filter(p => p.matchStatus === 'missing_in_qbo').length > 0 && (
                    <div style={{ borderTop: `1px solid ${colors.border}`, paddingTop: '12px', marginTop: '12px' }}>
                      <div onClick={() => toggleSection('gmailMissingPayments')} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', cursor: 'pointer', marginBottom: expandedSections.gmailMissingPayments ? '12px' : 0 }}>
                        <span style={{ fontSize: '13px', fontWeight: 500, color: colors.error }}>Payment Confirmations Not in QBO ({mockGmailPayments.filter(p => p.matchStatus === 'missing_in_qbo').length})</span>
                        <Icon name={expandedSections.gmailMissingPayments ? 'chevron-down' : 'chevron-right'} size={18} color={colors.slateLight} />
                      </div>

                      {expandedSections.gmailMissingPayments && (
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                          {mockGmailPayments.filter(p => p.matchStatus === 'missing_in_qbo').map((pmt, i) => (
                            <div key={i} style={{ padding: '12px', backgroundColor: colors.errorLight, borderRadius: '8px', border: `1px solid ${colors.error}` }}>
                              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '8px' }}>
                                <div>
                                  <div style={{ fontWeight: 600, color: colors.slate, fontSize: '14px' }}>{pmt.customer}</div>
                                  <div style={{ fontSize: '12px', color: colors.slateLight }}>{pmt.id} • {pmt.date}</div>
                                </div>
                                <div style={{ fontWeight: 700, color: colors.error, fontSize: '16px' }}>{fmt(pmt.amount)}</div>
                              </div>
                              <div style={{ fontSize: '12px', color: colors.slate, marginBottom: '4px' }}><strong>Subject:</strong> {pmt.subject}</div>
                              <div style={{ fontSize: '12px', color: colors.slateLight }}><strong>From:</strong> {pmt.sender}</div>
                              <div style={{ marginTop: '8px', padding: '8px', backgroundColor: colors.white, borderRadius: '4px', fontSize: '11px', color: colors.error }}>
                                <Icon name="alert-circle" size={12} style={{ marginRight: '4px' }} />
                                Payment confirmation found in Gmail but not recorded in QBO. This may indicate unrecorded cash received.
                              </div>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  )}
                </Card>

                {/* Spreadsheet Discrepancies */}
                <Card style={{ marginBottom: '16px', border: `1px solid ${colors.warning}` }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                    <h3 style={{ fontSize: '14px', fontWeight: 600, color: colors.slate, display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <Icon name="file-spreadsheet" size={16} color={colors.warning} /> Uploaded Spreadsheet: Items Not in QBO
                    </h3>
                    <Badge variant="warningLight">{mockSpreadsheetData.discrepancies.length} Discrepancies</Badge>
                  </div>

                  <div style={{ display: 'flex', gap: '16px', marginBottom: '16px', flexWrap: 'wrap' }}>
                    <div style={{ flex: 1, minWidth: '140px', padding: '12px', backgroundColor: colors.background, borderRadius: '8px' }}>
                      <div style={{ fontSize: '11px', color: colors.slateLight, marginBottom: '4px' }}>Spreadsheet Records</div>
                      <div style={{ fontSize: '20px', fontWeight: 700, color: colors.slate }}>{mockSpreadsheetData.totalRecords}</div>
                      <div style={{ fontSize: '12px', color: colors.slateLight }}>{mockSpreadsheetData.fileName}</div>
                    </div>
                    <div style={{ flex: 1, minWidth: '140px', padding: '12px', backgroundColor: colors.primaryLight, borderRadius: '8px' }}>
                      <div style={{ fontSize: '11px', color: colors.slateLight, marginBottom: '4px' }}>Matched to QBO</div>
                      <div style={{ fontSize: '20px', fontWeight: 700, color: colors.primary }}>{mockSpreadsheetData.totalRecords - mockSpreadsheetData.discrepancies.length}</div>
                      <div style={{ fontSize: '12px', color: colors.primary }}>transactions matched</div>
                    </div>
                    <div style={{ flex: 1, minWidth: '140px', padding: '12px', backgroundColor: colors.warningLight, borderRadius: '8px' }}>
                      <div style={{ fontSize: '11px', color: '#E65100', marginBottom: '4px' }}>Discrepancies</div>
                      <div style={{ fontSize: '20px', fontWeight: 700, color: '#E65100' }}>{mockSpreadsheetData.discrepancies.length}</div>
                      <div style={{ fontSize: '12px', color: '#E65100' }}>{fmt(mockSpreadsheetData.discrepancies.reduce((sum, d) => sum + d.amount, 0))} total</div>
                    </div>
                  </div>

                  {/* Expandable Discrepancy Details */}
                  <div style={{ borderTop: `1px solid ${colors.border}`, paddingTop: '12px' }}>
                    <div onClick={() => toggleSection('spreadsheetDiscrepancies')} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', cursor: 'pointer', marginBottom: expandedSections.spreadsheetDiscrepancies ? '12px' : 0 }}>
                      <span style={{ fontSize: '13px', fontWeight: 500, color: colors.warning }}>View Discrepancy Details ({mockSpreadsheetData.discrepancies.length})</span>
                      <Icon name={expandedSections.spreadsheetDiscrepancies ? 'chevron-down' : 'chevron-right'} size={18} color={colors.slateLight} />
                    </div>

                    {expandedSections.spreadsheetDiscrepancies && (
                      <div style={{ border: `1px solid ${colors.border}`, borderRadius: '8px', overflow: 'hidden' }}>
                        <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '12px' }}>
                          <thead>
                            <tr style={{ backgroundColor: colors.background }}>
                              <th style={{ padding: '10px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, fontSize: '10px', textTransform: 'uppercase' }}>Type</th>
                              <th style={{ padding: '10px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, fontSize: '10px', textTransform: 'uppercase' }}>Reference</th>
                              <th style={{ padding: '10px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, fontSize: '10px', textTransform: 'uppercase' }}>Customer</th>
                              <th style={{ padding: '10px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, fontSize: '10px', textTransform: 'uppercase' }}>Date</th>
                              <th style={{ padding: '10px', textAlign: 'right', fontWeight: 600, color: colors.slateLight, fontSize: '10px', textTransform: 'uppercase' }}>Amount</th>
                              <th style={{ padding: '10px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, fontSize: '10px', textTransform: 'uppercase' }}>Issue</th>
                              <th style={{ padding: '10px', textAlign: 'center', fontWeight: 600, color: colors.slateLight, fontSize: '10px', textTransform: 'uppercase' }}>Action</th>
                            </tr>
                          </thead>
                          <tbody>
                            {mockSpreadsheetData.discrepancies.map((disc, i) => (
                              <tr key={i} style={{ borderTop: `1px solid ${colors.border}`, backgroundColor: colors.warningLight }}>
                                <td style={{ padding: '10px' }}>
                                  <Badge variant={disc.type === 'invoice' ? 'purpleLight' : disc.type === 'payment' ? 'blueLight' : 'tealLight'} size="sm">
                                    {disc.type}
                                  </Badge>
                                </td>
                                <td style={{ padding: '10px', fontFamily: 'monospace', fontSize: '11px', color: colors.slate }}>{disc.ref}</td>
                                <td style={{ padding: '10px', fontWeight: 500, color: colors.slate }}>{disc.customer}</td>
                                <td style={{ padding: '10px', color: colors.slateLight }}>{disc.date}</td>
                                <td style={{ padding: '10px', textAlign: 'right', fontWeight: 600, color: colors.warning }}>{fmt(disc.amount)}</td>
                                <td style={{ padding: '10px', fontSize: '11px', color: colors.error }}>{disc.issue}</td>
                                <td style={{ padding: '10px', textAlign: 'center' }}>
                                  <Badge variant={disc.action === 'investigate' ? 'warningLight' : 'secondaryLight'} size="sm">
                                    {disc.action === 'create_invoice' ? 'Create Invoice' : disc.action === 'create_credit' ? 'Create Credit' : 'Investigate'}
                                  </Badge>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    )}
                  </div>

                  <div style={{ marginTop: '12px', padding: '10px', backgroundColor: '#F8F9FA', borderRadius: '6px', fontSize: '11px', color: colors.slateLight }}>
                    <Icon name="info" size={12} style={{ marginRight: '4px' }} />
                    <strong style={{ color: colors.slate }}>Source:</strong> {mockSpreadsheetData.fileName} • Uploaded {mockSpreadsheetData.uploadDate} • {mockSpreadsheetData.totalRecords} total records compared
                  </div>
                </Card>

                {/* Unapplied Payments */}
                <Card style={{ marginBottom: '16px' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                    <h3 style={{ fontSize: '14px', fontWeight: 600, color: colors.slate, display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <Icon name="credit-card" size={16} color={colors.secondary} /> Unapplied Payments Pool
                    </h3>
                    <span style={{ fontSize: '13px', color: colors.slateLight }}>5 payments • {fmt(21200)} total</span>
                  </div>

                  <div style={{ border: `1px solid ${colors.border}`, borderRadius: '8px', overflow: 'hidden' }}>
                    <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '12px' }}>
                      <thead>
                        <tr style={{ backgroundColor: colors.background }}>
                          <th style={{ padding: '10px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, fontSize: '10px', textTransform: 'uppercase' }}>Payment</th>
                          <th style={{ padding: '10px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, fontSize: '10px', textTransform: 'uppercase' }}>Customer</th>
                          <th style={{ padding: '10px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, fontSize: '10px', textTransform: 'uppercase' }}>Date</th>
                          <th style={{ padding: '10px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, fontSize: '10px', textTransform: 'uppercase' }}>Reference</th>
                          <th style={{ padding: '10px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, fontSize: '10px', textTransform: 'uppercase' }}>Memo</th>
                          <th style={{ padding: '10px', textAlign: 'right', fontWeight: 600, color: colors.slateLight, fontSize: '10px', textTransform: 'uppercase' }}>Unapplied</th>
                          <th style={{ padding: '10px', textAlign: 'center', fontWeight: 600, color: colors.slateLight, fontSize: '10px', textTransform: 'uppercase' }}>Match Likelihood</th>
                        </tr>
                      </thead>
                      <tbody>
                        {mockPayments.map((pmt, i) => {
                          const likelihood = pmt.memo && pmt.memo.includes('INV') ? 'high' : pmt.memo && pmt.customer !== 'Unknown Sender' ? 'medium' : 'low';
                          return (
                            <tr key={i} style={{ borderTop: `1px solid ${colors.border}` }}>
                              <td style={{ padding: '10px', fontWeight: 500, color: colors.secondary }}>{pmt.id}</td>
                              <td style={{ padding: '10px', color: pmt.customer === 'Unknown Sender' ? colors.error : colors.slate }}>{pmt.customer}</td>
                              <td style={{ padding: '10px', color: colors.slateLight }}>{pmt.date}</td>
                              <td style={{ padding: '10px', color: colors.slateLight, fontFamily: 'monospace', fontSize: '11px' }}>{pmt.ref}</td>
                              <td style={{ padding: '10px', color: pmt.memo ? colors.slate : colors.slateLight, fontStyle: pmt.memo ? 'normal' : 'italic' }}>{pmt.memo || 'No memo'}</td>
                              <td style={{ padding: '10px', textAlign: 'right', fontWeight: 600, color: colors.slate }}>{fmt(pmt.unapplied)}</td>
                              <td style={{ padding: '10px', textAlign: 'center' }}>
                                <Badge variant={likelihood === 'high' ? 'successLight' : likelihood === 'medium' ? 'warningLight' : 'errorLight'} size="sm">{likelihood}</Badge>
                              </td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                </Card>

                {/* Ghost Cash - Bank Deposits */}
                <Card style={{ marginBottom: '16px', border: `1px solid ${colors.error}` }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                    <h3 style={{ fontSize: '14px', fontWeight: 600, color: colors.slate, display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <Icon name="zap" size={16} color={colors.error} /> Ghost Cash (Bank Deposits Not Recorded)
                    </h3>
                    <Badge variant="errorLight">2 Unrecorded • {fmt(3000)}</Badge>
                  </div>

                  <p style={{ fontSize: '12px', color: colors.slateLight, marginBottom: '12px' }}>
                    These deposits appear in the bank feed but have no corresponding Payment record in QBO. They may represent unrecorded customer payments.
                  </p>

                  <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                    {[
                      { id: 'DEP-001', date: '2024-01-31', amount: 2500, description: 'DEPOSIT TECHSTART LLC ACH', bankAccount: 'Chase ****4521', potentialMatch: 'TechStart LLC (possible advance payment)' },
                      { id: 'DEP-002', date: '2024-01-31', amount: 500, description: 'STRIPE PAYOUT JAN', bankAccount: 'Chase ****4521', potentialMatch: 'Stripe batch - needs reconciliation' },
                    ].map((dep, i) => (
                      <div key={i} style={{ padding: '12px', backgroundColor: colors.errorLight, borderRadius: '8px', display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '12px' }}>
                        <div>
                          <div style={{ fontWeight: 600, color: colors.slate, fontSize: '13px' }}>{dep.description}</div>
                          <div style={{ fontSize: '11px', color: colors.slateLight }}>{dep.id} • {dep.date} • {dep.bankAccount}</div>
                        </div>
                        <div style={{ textAlign: 'right' }}>
                          <div style={{ fontWeight: 700, color: colors.error, fontSize: '16px' }}>{fmt(dep.amount)}</div>
                          <div style={{ fontSize: '11px', color: colors.slateLight }}>{dep.potentialMatch}</div>
                        </div>
                      </div>
                    ))}
                  </div>
                </Card>

                {/* Unapplied Credits */}
                <Card style={{ marginBottom: '16px' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                    <h3 style={{ fontSize: '14px', fontWeight: 600, color: colors.slate, display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <Icon name="file-text" size={16} color={colors.teal} /> Unapplied Credits & Adjustments
                    </h3>
                    <span style={{ fontSize: '13px', color: colors.slateLight }}>3 items • {fmt(1850)} total</span>
                  </div>

                  <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                    {[
                      { id: 'CM-201', type: 'Credit Memo', customer: 'Acme Corp', date: '2024-01-20', amount: 500, reason: 'Service credit - Q4 SLA breach' },
                      { id: 'CM-205', type: 'Credit Memo', customer: 'TechStart LLC', date: '2024-01-25', amount: 1000, reason: 'Promo discount - new customer' },
                      { id: 'JE-1042', type: 'Journal Entry', customer: 'Beta Holdings', date: '2024-01-28', amount: 350, reason: 'AR adjustment - duplicate charge reversal' },
                    ].map((credit, i) => (
                      <div key={i} style={{ padding: '12px', border: `1px solid ${colors.border}`, borderRadius: '8px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                          <Badge variant={credit.type === 'Credit Memo' ? 'tealLight' : 'purpleLight'} size="sm">{credit.type}</Badge>
                          <div>
                            <div style={{ fontWeight: 500, color: colors.slate, fontSize: '13px' }}>{credit.id} - {credit.customer}</div>
                            <div style={{ fontSize: '11px', color: colors.slateLight }}>{credit.date} • {credit.reason}</div>
                          </div>
                        </div>
                        <div style={{ fontWeight: 600, color: colors.teal }}>{fmt(credit.amount)}</div>
                      </div>
                    ))}
                  </div>
                </Card>

                {/* Data Sources (Collapsible) */}
                <Card style={{ marginBottom: '16px' }}>
                  <div onClick={() => toggleSection('dataSources')} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', cursor: 'pointer' }}>
                    <h3 style={{ fontSize: '14px', fontWeight: 600, color: colors.slate, display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <Icon name="database" size={16} color={colors.secondary} /> Data Sources Pulled
                    </h3>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <Badge variant="successLight" size="sm">8 sources • 484 records</Badge>
                      <Icon name={expandedSections.dataSources ? 'chevron-down' : 'chevron-right'} size={18} color={colors.slateLight} />
                    </div>
                  </div>

                  {expandedSections.dataSources && (
                    <div style={{ marginTop: '16px', display: 'flex', flexDirection: 'column', gap: '8px' }}>
                      {mockDataPullProgress.map(item => (
                        <div key={item.id} style={{ display: 'flex', alignItems: 'center', gap: '12px', padding: '8px 12px', backgroundColor: colors.background, borderRadius: '6px' }}>
                          <Icon name="check-circle" size={14} color={colors.primary} />
                          <div style={{ flex: 1, fontWeight: 500, color: colors.slate, fontSize: '13px' }}>{item.name}</div>
                          <div style={{ fontSize: '12px', color: colors.slateLight }}>{item.records} records</div>
                          <div style={{ fontSize: '11px', color: colors.slateLight }}>{item.time}</div>
                        </div>
                      ))}
                    </div>
                  )}
                </Card>

                {/* Summary & Next Steps */}
                <Card style={{ marginBottom: '24px', backgroundColor: colors.secondaryLight, border: `1px solid ${colors.secondary}` }}>
                  <h3 style={{ fontSize: '14px', fontWeight: 600, color: colors.secondary, marginBottom: '12px' }}>State Map Summary</h3>
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '12px', marginBottom: '12px' }}>
                    <div style={{ fontSize: '13px', color: colors.slate }}>
                      <Icon name="check-circle" size={14} color={colors.primary} style={{ marginRight: '6px' }} />
                      GL to Sub-Ledger: <strong>Balanced</strong>
                    </div>
                    <div style={{ fontSize: '13px', color: colors.slate }}>
                      <Icon name="alert-triangle" size={14} color={colors.warning} style={{ marginRight: '6px' }} />
                      Invoice Gaps: <strong>2 missing in QBO</strong>
                    </div>
                    <div style={{ fontSize: '13px', color: colors.slate }}>
                      <Icon name="credit-card" size={14} color={colors.secondary} style={{ marginRight: '6px' }} />
                      Cash to Apply: <strong>{fmt(21200)}</strong>
                    </div>
                    <div style={{ fontSize: '13px', color: colors.slate }}>
                      <Icon name="zap" size={14} color={colors.error} style={{ marginRight: '6px' }} />
                      Ghost Cash: <strong>{fmt(3000)}</strong>
                    </div>
                  </div>
                  <p style={{ fontSize: '12px', color: colors.secondary, margin: 0 }}>
                    The agent will now proceed to match unapplied payments to open invoices, identify missing invoices, and propose adjustments based on your SOP rules.
                  </p>
                </Card>

                <Button onClick={() => setPhase('matching')} iconName="chevron-right">Continue to Payment Matching</Button>
              </div>
            )}

            {/* PAYMENT MATCHING PHASE */}
            {phase === 'matching' && (
              <div>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                  <div>
                    <h1 style={{ fontSize: '24px', fontWeight: 700, color: colors.slate, marginBottom: '4px' }}>Payment Matching & Resolution</h1>
                    <p style={{ fontSize: '14px', color: colors.slateLight }}>AI-powered matching of payments to invoices</p>
                  </div>
                  <Badge variant="blueLight">Draft + Confirm</Badge>
                </div>

                <div style={{ display: 'flex', gap: '16px', marginBottom: '24px', flexWrap: 'wrap' }}>
                  <StatCard icon="credit-card" label="Unapplied Payments" value="5" subValue={fmt(21200)} color={colors.secondary} />
                  <StatCard icon="file-text" label="Open Invoices" value="7" subValue={fmt(21275)} color={colors.purple} />
                  <StatCard icon="check-circle" label="Matched" value="4" subValue={fmt(20000)} color={colors.primary} />
                  <StatCard icon="alert-triangle" label="Unmatched" value="1" subValue={fmt(1200)} color={colors.warning} />
                </div>

                {/* Match Proposals */}
                <Card style={{ marginBottom: '16px' }}>
                  <h3 style={{ fontSize: '14px', fontWeight: 600, color: colors.slate, marginBottom: '16px' }}>Match Proposals</h3>

                  {matches.map((match, idx) => (
                    <div key={idx} style={{ padding: '16px', border: `1px solid ${colors.border}`, borderRadius: '8px', marginBottom: '12px', backgroundColor: match.approved ? colors.white : '#FAFAFA' }}>
                      <div style={{ display: 'flex', gap: '12px' }}>
                        <Checkbox checked={match.approved} onChange={() => toggleMatch(idx)} />
                        <div style={{ flex: 1 }}>
                          <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '8px', flexWrap: 'wrap', gap: '8px' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px', flexWrap: 'wrap' }}>
                              <Badge variant={match.tier === 1 ? 'blueLight' : match.tier === 2 ? 'purpleLight' : 'orangeLight'}>Tier {match.tier}</Badge>
                              <Badge variant={match.confidence === 'exact' ? 'successLight' : match.confidence === 'high' ? 'successLight' : match.confidence === 'medium' ? 'warningLight' : 'errorLight'}>{match.confidence}</Badge>
                              <Badge variant={match.type === 'standard' ? 'default' : match.type === 'multi' ? 'purpleLight' : match.type === 'partial' ? 'warningLight' : 'errorLight'} size="sm">{match.type}</Badge>
                            </div>
                            <button onClick={() => toggleSection(`match_${idx}`)} style={{ display: 'flex', alignItems: 'center', gap: '4px', padding: '4px 10px', fontSize: '11px', fontWeight: 600, color: colors.secondary, backgroundColor: colors.secondaryLight, border: 'none', borderRadius: '4px', cursor: 'pointer' }}>
                              <Icon name={expandedSections[`match_${idx}`] ? 'chevron-down' : 'chevron-right'} size={14} />
                              {expandedSections[`match_${idx}`] ? 'Hide Details' : 'View Details'}
                            </button>
                          </div>

                          <div style={{ display: 'flex', gap: '24px', marginBottom: '12px', flexWrap: 'wrap' }}>
                            <div>
                              <div style={{ fontSize: '11px', color: colors.slateLight }}>Payment</div>
                              <div style={{ fontWeight: 600, color: colors.slate }}>{match.paymentId}</div>
                              <div style={{ fontSize: '12px', color: colors.slateLight }}>{match.payment.customer} • {fmt(match.payment.amount)}</div>
                            </div>
                            <div style={{ display: 'flex', alignItems: 'center' }}><Icon name="chevron-right" size={20} color={colors.slateLight} /></div>
                            <div>
                              <div style={{ fontSize: '11px', color: colors.slateLight }}>Invoice(s)</div>
                              <div style={{ fontWeight: 600, color: colors.secondary }}>{match.invoices.map(i => i.id).join(', ') || 'None'}</div>
                              <div style={{ fontSize: '12px', color: colors.slateLight }}>{match.invoices.length > 0 ? fmt(match.invoices.reduce((s, i) => s + i.balance, 0)) : 'N/A'}</div>
                            </div>
                            <div>
                              <div style={{ fontSize: '11px', color: colors.slateLight }}>Applied</div>
                              <div style={{ fontWeight: 600, color: colors.primary }}>{fmt(match.amountApplied)}</div>
                            </div>
                            {match.writeOff && (
                              <div>
                                <div style={{ fontSize: '11px', color: colors.slateLight }}>Write-off</div>
                                <div style={{ fontWeight: 600, color: colors.warning }}>{fmt(match.writeOff)}</div>
                              </div>
                            )}
                          </div>

                          {/* Expanded Details Section */}
                          {expandedSections[`match_${idx}`] && (
                            <div style={{ marginBottom: '12px', padding: '16px', backgroundColor: colors.background, borderRadius: '8px', border: `1px solid ${colors.border}` }}>
                              {/* Payment Details */}
                              <div style={{ marginBottom: '16px' }}>
                                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '12px' }}>
                                  <h4 style={{ fontSize: '13px', fontWeight: 600, color: colors.slate, margin: 0, display: 'flex', alignItems: 'center', gap: '6px' }}>
                                    <Icon name="credit-card" size={14} color={colors.secondary} /> Payment Details
                                  </h4>
                                  <a href="#" onClick={(e) => e.preventDefault()} style={{ fontSize: '11px', color: colors.secondary, textDecoration: 'none', display: 'flex', alignItems: 'center', gap: '4px' }}>
                                    <Icon name="external-link" size={12} /> View in QuickBooks
                                  </a>
                                </div>
                                <div style={{ backgroundColor: colors.white, borderRadius: '6px', border: `1px solid ${colors.border}`, overflow: 'hidden' }}>
                                  <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '12px' }}>
                                    <thead>
                                      <tr style={{ backgroundColor: colors.background }}>
                                        <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Payment ID</th>
                                        <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Customer</th>
                                        <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Date</th>
                                        <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Method</th>
                                        <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Reference</th>
                                        <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Memo</th>
                                        <th style={{ padding: '8px 12px', textAlign: 'right', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Amount</th>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      <tr>
                                        <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}>
                                          <a href="#" onClick={(e) => e.preventDefault()} style={{ color: colors.secondary, textDecoration: 'none', fontWeight: 500 }}>{match.payment.id}</a>
                                        </td>
                                        <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, color: colors.slate }}>{match.payment.customer}</td>
                                        <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, color: colors.slate }}>{match.payment.date}</td>
                                        <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}>
                                          <Badge variant={match.payment.method === 'Wire' ? 'tealLight' : match.payment.method === 'ACH' ? 'blueLight' : 'default'} size="sm">{match.payment.method}</Badge>
                                        </td>
                                        <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, color: colors.slateLight, fontFamily: 'monospace', fontSize: '11px' }}>{match.payment.ref}</td>
                                        <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, color: colors.slateLight, fontStyle: 'italic' }}>{match.payment.memo || '—'}</td>
                                        <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'right', fontWeight: 600, color: colors.primary }}>{fmt(match.payment.amount)}</td>
                                      </tr>
                                    </tbody>
                                  </table>
                                </div>
                              </div>

                              {/* Invoice Details */}
                              {match.invoices.length > 0 && (
                                <div>
                                  <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '12px' }}>
                                    <h4 style={{ fontSize: '13px', fontWeight: 600, color: colors.slate, margin: 0, display: 'flex', alignItems: 'center', gap: '6px' }}>
                                      <Icon name="file-text" size={14} color={colors.purple} /> Invoice Details ({match.invoices.length})
                                    </h4>
                                    <a href="#" onClick={(e) => e.preventDefault()} style={{ fontSize: '11px', color: colors.secondary, textDecoration: 'none', display: 'flex', alignItems: 'center', gap: '4px' }}>
                                      <Icon name="external-link" size={12} /> View All in QuickBooks
                                    </a>
                                  </div>
                                  <div style={{ backgroundColor: colors.white, borderRadius: '6px', border: `1px solid ${colors.border}`, overflow: 'hidden' }}>
                                    <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '12px' }}>
                                      <thead>
                                        <tr style={{ backgroundColor: colors.background }}>
                                          <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Invoice #</th>
                                          <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Customer</th>
                                          <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Date</th>
                                          <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Due Date</th>
                                          <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Class</th>
                                          <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Aging</th>
                                          <th style={{ padding: '8px 12px', textAlign: 'right', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Amount</th>
                                          <th style={{ padding: '8px 12px', textAlign: 'right', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Balance</th>
                                        </tr>
                                      </thead>
                                      <tbody>
                                        {match.invoices.map((inv, invIdx) => (
                                          <tr key={invIdx}>
                                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}>
                                              <a href="#" onClick={(e) => e.preventDefault()} style={{ color: colors.secondary, textDecoration: 'none', fontWeight: 500 }}>{inv.id}</a>
                                            </td>
                                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, color: colors.slate }}>{inv.customer}</td>
                                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, color: colors.slate }}>{inv.date}</td>
                                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, color: colors.slate }}>{inv.dueDate}</td>
                                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}>
                                              <Badge variant="purpleLight" size="sm">{inv.class}</Badge>
                                            </td>
                                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}>
                                              <Badge variant={inv.aging === 'Current' ? 'successLight' : inv.aging === '1-30' ? 'warningLight' : 'errorLight'} size="sm">{inv.aging}</Badge>
                                            </td>
                                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'right', color: colors.slate }}>{fmt(inv.amount)}</td>
                                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'right', fontWeight: 600, color: colors.primary }}>{fmt(inv.balance)}</td>
                                          </tr>
                                        ))}
                                        <tr style={{ backgroundColor: colors.background }}>
                                          <td colSpan="6" style={{ padding: '10px 12px', fontWeight: 600, color: colors.slate }}>Total</td>
                                          <td style={{ padding: '10px 12px', textAlign: 'right', fontWeight: 600, color: colors.slate }}>{fmt(match.invoices.reduce((s, i) => s + i.amount, 0))}</td>
                                          <td style={{ padding: '10px 12px', textAlign: 'right', fontWeight: 700, color: colors.primary }}>{fmt(match.invoices.reduce((s, i) => s + i.balance, 0))}</td>
                                        </tr>
                                      </tbody>
                                    </table>
                                  </div>
                                </div>
                              )}

                              {/* No invoices matched */}
                              {match.invoices.length === 0 && (
                                <div style={{ padding: '16px', backgroundColor: colors.warningLight, borderRadius: '6px', border: `1px dashed ${colors.warning}` }}>
                                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
                                    <Icon name="alert-triangle" size={16} color={colors.warning} />
                                    <span style={{ fontWeight: 600, color: colors.slate }}>No Matching Invoices Found</span>
                                  </div>
                                  <p style={{ margin: 0, fontSize: '12px', color: colors.slateLight }}>This payment could not be matched to any open invoices. Manual investigation required.</p>
                                </div>
                              )}

                              {/* Artifact Links */}
                              <div style={{ marginTop: '16px', paddingTop: '12px', borderTop: `1px solid ${colors.border}` }}>
                                <div style={{ fontSize: '11px', fontWeight: 600, color: colors.slateLight, marginBottom: '8px', textTransform: 'uppercase' }}>Related Reports & Documents</div>
                                <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
                                  <a href="#" onClick={(e) => e.preventDefault()} style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px', color: colors.secondary, textDecoration: 'none' }}>
                                    <Icon name="file-text" size={14} /> Payment Receipt
                                  </a>
                                  {match.invoices.length > 0 && (
                                    <>
                                      <a href="#" onClick={(e) => e.preventDefault()} style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px', color: colors.secondary, textDecoration: 'none' }}>
                                        <Icon name="file-text" size={14} /> Invoice PDF
                                      </a>
                                      <a href="#" onClick={(e) => e.preventDefault()} style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px', color: colors.secondary, textDecoration: 'none' }}>
                                        <Icon name="history" size={14} /> Transaction History
                                      </a>
                                    </>
                                  )}
                                  <a href="#" onClick={(e) => e.preventDefault()} style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px', color: colors.secondary, textDecoration: 'none' }}>
                                    <Icon name="database" size={14} /> Customer Ledger
                                  </a>
                                  {match.payment.method === 'ACH' || match.payment.method === 'Wire' ? (
                                    <a href="#" onClick={(e) => e.preventDefault()} style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px', color: colors.secondary, textDecoration: 'none' }}>
                                      <Icon name="credit-card" size={14} /> Bank Statement Entry
                                    </a>
                                  ) : null}
                                </div>
                              </div>
                            </div>
                          )}

                          <div style={{ backgroundColor: colors.background, borderRadius: '6px', padding: '12px', borderLeft: `3px solid ${colors.secondary}` }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '6px', marginBottom: '6px', color: colors.secondary, fontWeight: 600, fontSize: '11px', textTransform: 'uppercase' }}>
                              <Icon name="sparkles" size={12} /> AI Analysis
                            </div>
                            <p style={{ margin: 0, color: colors.slate, fontSize: '13px', lineHeight: 1.5, fontFamily: 'Georgia, serif' }}>{match.reasoning}</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </Card>

                {/* Ghost Cash */}
                {mockGhostCash.length > 0 && (
                  <Card style={{ marginBottom: '16px' }}>
                    <h3 style={{ fontSize: '14px', fontWeight: 600, color: colors.slate, marginBottom: '12px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <Icon name="zap" size={16} color={colors.warning} /> Ghost Cash (Bank Feed)
                    </h3>
                    {mockGhostCash.map(gc => (
                      <div key={gc.id} style={{ padding: '12px', border: `1px solid ${colors.border}`, borderRadius: '8px', backgroundColor: colors.warningLight }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                          <div style={{ fontWeight: 600, color: colors.slate }}>{gc.bankRef} • {fmt(gc.amount)}</div>
                          <Badge variant="warningLight">Unmatched Deposit</Badge>
                        </div>
                        <p style={{ fontSize: '12px', color: colors.slateLight, margin: 0 }}>{gc.reasoning}</p>
                      </div>
                    ))}
                  </Card>
                )}

                {/* Summary Bar */}
                <Card style={{ position: 'sticky', bottom: '16px', boxShadow: '0 -4px 20px rgba(0,0,0,0.1)' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '16px' }}>
                    <div style={{ display: 'flex', gap: '24px' }}>
                      <div><span style={{ fontSize: '12px', color: colors.slateLight }}>Total Applied:</span><span style={{ fontSize: '16px', fontWeight: 700, color: colors.primary, marginLeft: '8px' }}>{fmt(matches.filter(m => m.approved).reduce((s, m) => s + m.amountApplied, 0))}</span></div>
                      <div><span style={{ fontSize: '12px', color: colors.slateLight }}>Write-offs:</span><span style={{ fontSize: '16px', fontWeight: 700, color: colors.warning, marginLeft: '8px' }}>{fmt(matches.filter(m => m.approved && m.writeOff).reduce((s, m) => s + (m.writeOff || 0), 0))}</span></div>
                    </div>
                    <div style={{ display: 'flex', gap: '12px' }}>
                      <Button variant="secondary" onClick={() => setPhase('data_pull')}>Back</Button>
                      <Button onClick={() => setPhase('gap_analysis')} iconName="check">Approve Matches & Continue</Button>
                    </div>
                  </div>
                </Card>
              </div>
            )}

            {/* GAP ANALYSIS PHASE */}
            {phase === 'gap_analysis' && (
              <div style={{ maxWidth: '900px' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                  <div>
                    <h1 style={{ fontSize: '24px', fontWeight: 700, color: colors.slate, marginBottom: '4px' }}>Gap Analysis</h1>
                    <p style={{ fontSize: '14px', color: colors.slateLight }}>Compare external billing data against QBO to identify missing invoices</p>
                  </div>
                  <Badge variant="blueLight">Draft + Confirm</Badge>
                </div>

                <div style={{ display: 'flex', gap: '16px', marginBottom: '24px', flexWrap: 'wrap' }}>
                  <StatCard icon="database" label="External Records" value="52" subValue="Stripe + Upload" color={colors.secondary} />
                  <StatCard icon="file-text" label="QBO Invoices" value="47" subValue="Current period" color={colors.purple} />
                  <StatCard icon="alert-triangle" label="Missing in QBO" value="2" subValue={fmt(2250)} color={colors.warning} />
                </div>

                <Card style={{ marginBottom: '16px' }}>
                  <h3 style={{ fontSize: '14px', fontWeight: 600, color: colors.slate, marginBottom: '12px' }}>Proposed Ghost Invoices</h3>
                  <p style={{ fontSize: '13px', color: colors.slateLight, marginBottom: '16px' }}>These invoices exist in external systems but are missing from QuickBooks</p>

                  {mockGapAnalysis.map((gap, idx) => (
                    <div key={gap.id} style={{ padding: '14px', border: `1px solid ${colors.border}`, borderRadius: '8px', marginBottom: '8px', display: 'flex', alignItems: 'center', gap: '12px' }}>
                      <Checkbox checked={gap.approved !== false} onChange={() => toggleGap(idx)} />
                      <div style={{ flex: 1 }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '4px' }}>
                          <span style={{ fontWeight: 600, color: colors.slate }}>{gap.customer}</span>
                          <Badge variant="warningLight" size="sm">Missing in QBO</Badge>
                        </div>
                        <div style={{ fontSize: '12px', color: colors.slateLight }}>Ref: {gap.externalRef} • {gap.date} • Source: {gap.source}</div>
                      </div>
                      <div style={{ fontWeight: 600, color: colors.primary }}>{fmt(gap.amount)}</div>
                    </div>
                  ))}
                </Card>

                <Card style={{ marginBottom: '24px' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <div>
                      <span style={{ fontSize: '12px', color: colors.slateLight }}>Invoices to Create:</span>
                      <span style={{ fontSize: '16px', fontWeight: 700, color: colors.primary, marginLeft: '8px' }}>2 ({fmt(2250)})</span>
                    </div>
                    <div style={{ display: 'flex', gap: '12px' }}>
                      <Button variant="secondary" onClick={() => setPhase('matching')}>Back</Button>
                      <Button onClick={() => setPhase('adjustments')} iconName="check">Approve & Create Invoices</Button>
                    </div>
                  </div>
                </Card>
              </div>
            )}

            {/* ADJUSTMENTS PHASE */}
            {phase === 'adjustments' && (
              <div style={{ maxWidth: '900px' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                  <div>
                    <h1 style={{ fontSize: '24px', fontWeight: 700, color: colors.slate, marginBottom: '4px' }}>Rules-Based Adjustments</h1>
                    <p style={{ fontSize: '14px', color: colors.slateLight }}>Execute SOP-driven adjustments: Netting, Write-offs, Balance Clearings</p>
                  </div>
                  <Badge variant="blueLight">Draft + Confirm</Badge>
                </div>

                <div style={{ display: 'flex', gap: '16px', marginBottom: '24px', flexWrap: 'wrap' }}>
                  <StatCard icon="scale" label="Netting" value="1" subValue={fmt(1200)} color={colors.secondary} />
                  <StatCard icon="x-circle" label="Write-offs" value="1" subValue={fmt(125)} color={colors.error} />
                  <StatCard icon="dollar-sign" label="Small Balance" value="1" subValue={fmt(0.47)} color={colors.warning} />
                </div>

                <Card style={{ marginBottom: '16px' }}>
                  <h3 style={{ fontSize: '14px', fontWeight: 600, color: colors.slate, marginBottom: '12px' }}>Proposed Adjustments</h3>

                  {mockAdjustments.map((adj, idx) => (
                    <div key={adj.id} style={{ padding: '16px', border: `1px solid ${colors.border}`, borderRadius: '8px', marginBottom: '12px' }}>
                      <div style={{ display: 'flex', gap: '12px' }}>
                        <Checkbox checked={adj.approved} onChange={() => toggleAdjustment(idx)} />
                        <div style={{ flex: 1 }}>
                          <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '8px', flexWrap: 'wrap', gap: '8px' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                              <Badge variant={adj.type === 'netting' ? 'blueLight' : adj.type === 'write_off' ? 'errorLight' : 'warningLight'}>{adj.type.replace('_', ' ')}</Badge>
                              <span style={{ fontWeight: 600, color: colors.slate }}>{adj.customer}</span>
                            </div>
                            <button onClick={() => toggleSection(`adj_${idx}`)} style={{ display: 'flex', alignItems: 'center', gap: '4px', padding: '4px 10px', fontSize: '11px', fontWeight: 600, color: colors.secondary, backgroundColor: colors.secondaryLight, border: 'none', borderRadius: '4px', cursor: 'pointer' }}>
                              <Icon name={expandedSections[`adj_${idx}`] ? 'chevron-down' : 'chevron-right'} size={14} />
                              {expandedSections[`adj_${idx}`] ? 'Hide Transaction' : 'View Transaction'}
                            </button>
                          </div>

                          {adj.type === 'netting' && (
                            <div style={{ marginBottom: '12px' }}>
                              {/* Before Netting */}
                              <div style={{ display: 'flex', alignItems: 'center', gap: '16px', marginBottom: '12px' }}>
                                <div style={{ padding: '10px 14px', backgroundColor: colors.background, borderRadius: '6px', minWidth: '120px' }}>
                                  <span style={{ fontSize: '10px', color: colors.slateLight, textTransform: 'uppercase', fontWeight: 600 }}>Before</span>
                                  <div style={{ display: 'flex', gap: '16px', marginTop: '4px' }}>
                                    <div><span style={{ fontSize: '11px', color: colors.slateLight }}>AR</span><div style={{ fontWeight: 600, color: colors.slate }}>{fmt(adj.arBalance)}</div></div>
                                    <div><span style={{ fontSize: '11px', color: colors.slateLight }}>AP</span><div style={{ fontWeight: 600, color: colors.slate }}>{fmt(adj.apBalance)}</div></div>
                                  </div>
                                </div>

                                {/* Arrow and JE Amount */}
                                <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
                                  <Icon name="chevron-right" size={20} color={colors.secondary} />
                                  <div style={{ fontSize: '10px', color: colors.secondary, fontWeight: 600 }}>JE: {fmt(adj.offsetAmount)}</div>
                                </div>

                                {/* After Netting */}
                                <div style={{ padding: '10px 14px', backgroundColor: colors.primaryLight, borderRadius: '6px', minWidth: '120px' }}>
                                  <span style={{ fontSize: '10px', color: colors.primaryDark, textTransform: 'uppercase', fontWeight: 600 }}>After</span>
                                  <div style={{ display: 'flex', gap: '16px', marginTop: '4px' }}>
                                    <div><span style={{ fontSize: '11px', color: colors.slateLight }}>AR</span><div style={{ fontWeight: 600, color: adj.remainingAR > 0 ? colors.primary : colors.slateLight }}>{fmt(adj.remainingAR)}</div></div>
                                    <div><span style={{ fontSize: '11px', color: colors.slateLight }}>AP</span><div style={{ fontWeight: 600, color: adj.remainingAP > 0 ? colors.error : colors.slateLight }}>{fmt(adj.remainingAP)}</div></div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          )}

                          {adj.type === 'write_off' && (
                            <div style={{ display: 'flex', gap: '24px', marginBottom: '12px' }}>
                              <div><span style={{ fontSize: '11px', color: colors.slateLight }}>Balance</span><div style={{ fontWeight: 600, color: colors.error }}>{fmt(adj.balance)}</div></div>
                              <div><span style={{ fontSize: '11px', color: colors.slateLight }}>Aging</span><div style={{ fontWeight: 500, color: colors.slate }}>{adj.aging}</div></div>
                              <div><span style={{ fontSize: '11px', color: colors.slateLight }}>Reason</span><div style={{ fontWeight: 500, color: colors.slate }}>{adj.reason}</div></div>
                            </div>
                          )}

                          {adj.type === 'small_balance' && (
                            <div style={{ display: 'flex', gap: '24px', marginBottom: '12px' }}>
                              <div><span style={{ fontSize: '11px', color: colors.slateLight }}>Balance</span><div style={{ fontWeight: 600, color: colors.warning }}>{fmt(adj.balance)}</div></div>
                              <div><span style={{ fontSize: '11px', color: colors.slateLight }}>Reason</span><div style={{ fontWeight: 500, color: colors.slate }}>{adj.reason}</div></div>
                            </div>
                          )}

                          {/* Expanded Transaction Details */}
                          {expandedSections[`adj_${idx}`] && (
                            <div style={{ marginBottom: '12px', padding: '16px', backgroundColor: colors.background, borderRadius: '8px', border: `1px solid ${colors.border}` }}>

                              {/* Netting Transaction Details */}
                              {adj.type === 'netting' && (
                                <div>
                                  <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '12px' }}>
                                    <h4 style={{ fontSize: '13px', fontWeight: 600, color: colors.slate, margin: 0, display: 'flex', alignItems: 'center', gap: '6px' }}>
                                      <Icon name="file-text" size={14} color={colors.secondary} /> Journal Entry Details
                                    </h4>
                                    <Badge variant="blueLight" size="sm">Draft</Badge>
                                  </div>

                                  {/* JE Header */}
                                  <div style={{ backgroundColor: colors.white, borderRadius: '6px', border: `1px solid ${colors.border}`, marginBottom: '12px', overflow: 'hidden' }}>
                                    <div style={{ padding: '12px', borderBottom: `1px solid ${colors.border}`, display: 'flex', gap: '24px', flexWrap: 'wrap' }}>
                                      <div><span style={{ fontSize: '11px', color: colors.slateLight }}>Transaction Type</span><div style={{ fontWeight: 600, color: colors.slate, fontSize: '13px' }}>Journal Entry</div></div>
                                      <div><span style={{ fontSize: '11px', color: colors.slateLight }}>Date</span><div style={{ fontWeight: 500, color: colors.slate, fontSize: '13px' }}>2024-01-31</div></div>
                                      <div><span style={{ fontSize: '11px', color: colors.slateLight }}>Reference</span><div style={{ fontWeight: 500, color: colors.slate, fontSize: '13px', fontFamily: 'monospace' }}>JE-NET-{adj.customer.replace(/\s/g, '').substring(0,4).toUpperCase()}-0131</div></div>
                                      <div><span style={{ fontSize: '11px', color: colors.slateLight }}>Memo</span><div style={{ fontWeight: 500, color: colors.slate, fontSize: '13px' }}>AR/AP Netting - {adj.customer}</div></div>
                                    </div>

                                    {/* JE Lines */}
                                    <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '12px' }}>
                                      <thead>
                                        <tr style={{ backgroundColor: '#F8F9FA' }}>
                                          <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight }}>Line</th>
                                          <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight }}>Account</th>
                                          <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight }}>Name</th>
                                          <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight }}>Class</th>
                                          <th style={{ padding: '8px 12px', textAlign: 'right', fontWeight: 600, color: colors.slateLight }}>Debit</th>
                                          <th style={{ padding: '8px 12px', textAlign: 'right', fontWeight: 600, color: colors.slateLight }}>Credit</th>
                                        </tr>
                                      </thead>
                                      <tbody>
                                        <tr>
                                          <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}>1</td>
                                          <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}>
                                            <a href="#" onClick={(e) => e.preventDefault()} style={{ color: colors.secondary, textDecoration: 'none' }}>2000 - Accounts Payable</a>
                                          </td>
                                          <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}>{adj.customer}</td>
                                          <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}><Badge variant="purpleLight" size="sm">Operations</Badge></td>
                                          <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'right', fontWeight: 600, color: colors.slate }}>{fmt(adj.offsetAmount)}</td>
                                          <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'right', color: colors.slateLight }}>—</td>
                                        </tr>
                                        <tr>
                                          <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}>2</td>
                                          <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}>
                                            <a href="#" onClick={(e) => e.preventDefault()} style={{ color: colors.secondary, textDecoration: 'none' }}>1200 - Accounts Receivable</a>
                                          </td>
                                          <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}>{adj.customer}</td>
                                          <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}><Badge variant="purpleLight" size="sm">Operations</Badge></td>
                                          <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'right', color: colors.slateLight }}>—</td>
                                          <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'right', fontWeight: 600, color: colors.slate }}>{fmt(adj.offsetAmount)}</td>
                                        </tr>
                                        <tr style={{ backgroundColor: '#F8F9FA' }}>
                                          <td colSpan="4" style={{ padding: '10px 12px', fontWeight: 600, color: colors.slate }}>Total</td>
                                          <td style={{ padding: '10px 12px', textAlign: 'right', fontWeight: 700, color: colors.primary }}>{fmt(adj.offsetAmount)}</td>
                                          <td style={{ padding: '10px 12px', textAlign: 'right', fontWeight: 700, color: colors.primary }}>{fmt(adj.offsetAmount)}</td>
                                        </tr>
                                      </tbody>
                                    </table>
                                  </div>

                                  {/* Linked Documents */}
                                  <div style={{ paddingTop: '12px', borderTop: `1px solid ${colors.border}` }}>
                                    <div style={{ fontSize: '11px', fontWeight: 600, color: colors.slateLight, marginBottom: '8px', textTransform: 'uppercase' }}>Related Documents</div>
                                    <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
                                      <a href="#" onClick={(e) => e.preventDefault()} style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px', color: colors.secondary, textDecoration: 'none' }}>
                                        <Icon name="file-text" size={14} /> AP Aging Detail - {adj.customer}
                                      </a>
                                      <a href="#" onClick={(e) => e.preventDefault()} style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px', color: colors.secondary, textDecoration: 'none' }}>
                                        <Icon name="file-text" size={14} /> AR Aging Detail - {adj.customer}
                                      </a>
                                      <a href="#" onClick={(e) => e.preventDefault()} style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px', color: colors.secondary, textDecoration: 'none' }}>
                                        <Icon name="database" size={14} /> Customer/Vendor Record
                                      </a>
                                    </div>
                                  </div>
                                </div>
                              )}

                              {/* Write-off Transaction Details */}
                              {adj.type === 'write_off' && (
                                <div>
                                  <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '12px' }}>
                                    <h4 style={{ fontSize: '13px', fontWeight: 600, color: colors.slate, margin: 0, display: 'flex', alignItems: 'center', gap: '6px' }}>
                                      <Icon name="file-text" size={14} color={colors.error} /> Credit Memo & Journal Entry
                                    </h4>
                                    <Badge variant="errorLight" size="sm">Draft</Badge>
                                  </div>

                                  {/* Source Invoice */}
                                  <div style={{ backgroundColor: colors.white, borderRadius: '6px', border: `1px solid ${colors.border}`, marginBottom: '12px', overflow: 'hidden' }}>
                                    <div style={{ padding: '10px 12px', backgroundColor: '#F8F9FA', fontWeight: 600, fontSize: '12px', color: colors.slate, borderBottom: `1px solid ${colors.border}` }}>
                                      Source Invoice Being Written Off
                                    </div>
                                    <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '12px' }}>
                                      <thead>
                                        <tr>
                                          <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight }}>Invoice #</th>
                                          <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight }}>Date</th>
                                          <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight }}>Due Date</th>
                                          <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight }}>Days Overdue</th>
                                          <th style={{ padding: '8px 12px', textAlign: 'right', fontWeight: 600, color: colors.slateLight }}>Balance</th>
                                        </tr>
                                      </thead>
                                      <tbody>
                                        <tr>
                                          <td style={{ padding: '10px 12px' }}>
                                            <a href="#" onClick={(e) => e.preventDefault()} style={{ color: colors.secondary, textDecoration: 'none', fontWeight: 500 }}>INV-1029</a>
                                          </td>
                                          <td style={{ padding: '10px 12px', color: colors.slate }}>2023-09-01</td>
                                          <td style={{ padding: '10px 12px', color: colors.slate }}>2023-10-01</td>
                                          <td style={{ padding: '10px 12px' }}><Badge variant="errorLight" size="sm">122 days</Badge></td>
                                          <td style={{ padding: '10px 12px', textAlign: 'right', fontWeight: 600, color: colors.error }}>{fmt(adj.balance)}</td>
                                        </tr>
                                      </tbody>
                                    </table>
                                  </div>

                                  {/* Credit Memo */}
                                  <div style={{ backgroundColor: colors.white, borderRadius: '6px', border: `1px solid ${colors.border}`, marginBottom: '12px', overflow: 'hidden' }}>
                                    <div style={{ padding: '10px 12px', backgroundColor: '#F8F9FA', fontWeight: 600, fontSize: '12px', color: colors.slate, borderBottom: `1px solid ${colors.border}` }}>
                                      Credit Memo to be Created
                                    </div>
                                    <div style={{ padding: '12px', display: 'flex', gap: '24px', flexWrap: 'wrap', borderBottom: `1px solid ${colors.border}` }}>
                                      <div><span style={{ fontSize: '11px', color: colors.slateLight }}>Type</span><div style={{ fontWeight: 600, color: colors.slate, fontSize: '13px' }}>Credit Memo</div></div>
                                      <div><span style={{ fontSize: '11px', color: colors.slateLight }}>Date</span><div style={{ fontWeight: 500, color: colors.slate, fontSize: '13px' }}>2024-01-31</div></div>
                                      <div><span style={{ fontSize: '11px', color: colors.slateLight }}>Customer</span><div style={{ fontWeight: 500, color: colors.slate, fontSize: '13px' }}>{adj.customer}</div></div>
                                      <div><span style={{ fontSize: '11px', color: colors.slateLight }}>Applied To</span><div style={{ fontWeight: 500, color: colors.secondary, fontSize: '13px' }}>INV-1029</div></div>
                                    </div>
                                    <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '12px' }}>
                                      <thead>
                                        <tr>
                                          <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight }}>Account</th>
                                          <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight }}>Description</th>
                                          <th style={{ padding: '8px 12px', textAlign: 'right', fontWeight: 600, color: colors.slateLight }}>Amount</th>
                                        </tr>
                                      </thead>
                                      <tbody>
                                        <tr>
                                          <td style={{ padding: '10px 12px' }}>
                                            <a href="#" onClick={(e) => e.preventDefault()} style={{ color: colors.secondary, textDecoration: 'none' }}>6200 - Bad Debt Expense</a>
                                          </td>
                                          <td style={{ padding: '10px 12px', color: colors.slateLight }}>Write-off of uncollectible balance - INV-1029</td>
                                          <td style={{ padding: '10px 12px', textAlign: 'right', fontWeight: 600, color: colors.error }}>{fmt(adj.balance)}</td>
                                        </tr>
                                      </tbody>
                                    </table>
                                  </div>

                                  {/* GL Impact */}
                                  <div style={{ backgroundColor: '#FFF8E1', borderRadius: '6px', padding: '12px', marginBottom: '12px', border: `1px solid ${colors.warning}` }}>
                                    <div style={{ fontSize: '11px', fontWeight: 600, color: colors.warning, marginBottom: '4px', textTransform: 'uppercase' }}>GL Impact</div>
                                    <div style={{ fontSize: '12px', color: colors.slate }}>
                                      <strong>Dr</strong> 6200 - Bad Debt Expense {fmt(adj.balance)} | <strong>Cr</strong> 1200 - Accounts Receivable {fmt(adj.balance)}
                                    </div>
                                  </div>

                                  {/* Linked Documents */}
                                  <div style={{ paddingTop: '12px', borderTop: `1px solid ${colors.border}` }}>
                                    <div style={{ fontSize: '11px', fontWeight: 600, color: colors.slateLight, marginBottom: '8px', textTransform: 'uppercase' }}>Related Documents</div>
                                    <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
                                      <a href="#" onClick={(e) => e.preventDefault()} style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px', color: colors.secondary, textDecoration: 'none' }}>
                                        <Icon name="file-text" size={14} /> Invoice INV-1029
                                      </a>
                                      <a href="#" onClick={(e) => e.preventDefault()} style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px', color: colors.secondary, textDecoration: 'none' }}>
                                        <Icon name="history" size={14} /> Collection History
                                      </a>
                                      <a href="#" onClick={(e) => e.preventDefault()} style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px', color: colors.secondary, textDecoration: 'none' }}>
                                        <Icon name="database" size={14} /> Customer Ledger
                                      </a>
                                    </div>
                                  </div>
                                </div>
                              )}

                              {/* Small Balance Transaction Details */}
                              {adj.type === 'small_balance' && (
                                <div>
                                  <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '12px' }}>
                                    <h4 style={{ fontSize: '13px', fontWeight: 600, color: colors.slate, margin: 0, display: 'flex', alignItems: 'center', gap: '6px' }}>
                                      <Icon name="file-text" size={14} color={colors.warning} /> Balance Clearing Entry
                                    </h4>
                                    <Badge variant="warningLight" size="sm">Draft</Badge>
                                  </div>

                                  {/* Source Invoice */}
                                  <div style={{ backgroundColor: colors.white, borderRadius: '6px', border: `1px solid ${colors.border}`, marginBottom: '12px', overflow: 'hidden' }}>
                                    <div style={{ padding: '10px 12px', backgroundColor: '#F8F9FA', fontWeight: 600, fontSize: '12px', color: colors.slate, borderBottom: `1px solid ${colors.border}` }}>
                                      Invoice with Residual Balance
                                    </div>
                                    <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '12px' }}>
                                      <thead>
                                        <tr>
                                          <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight }}>Invoice #</th>
                                          <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight }}>Original Amount</th>
                                          <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight }}>Payments Applied</th>
                                          <th style={{ padding: '8px 12px', textAlign: 'right', fontWeight: 600, color: colors.slateLight }}>Remaining</th>
                                        </tr>
                                      </thead>
                                      <tbody>
                                        <tr>
                                          <td style={{ padding: '10px 12px' }}>
                                            <a href="#" onClick={(e) => e.preventDefault()} style={{ color: colors.secondary, textDecoration: 'none', fontWeight: 500 }}>INV-1038</a>
                                          </td>
                                          <td style={{ padding: '10px 12px', color: colors.slate }}>{fmt(950.00)}</td>
                                          <td style={{ padding: '10px 12px', color: colors.primary }}>{fmt(949.53)}</td>
                                          <td style={{ padding: '10px 12px', textAlign: 'right', fontWeight: 600, color: colors.warning }}>{fmt(adj.balance)}</td>
                                        </tr>
                                      </tbody>
                                    </table>
                                  </div>

                                  {/* Credit Memo */}
                                  <div style={{ backgroundColor: colors.white, borderRadius: '6px', border: `1px solid ${colors.border}`, marginBottom: '12px', overflow: 'hidden' }}>
                                    <div style={{ padding: '10px 12px', backgroundColor: '#F8F9FA', fontWeight: 600, fontSize: '12px', color: colors.slate, borderBottom: `1px solid ${colors.border}` }}>
                                      Credit Memo to Clear Balance
                                    </div>
                                    <div style={{ padding: '12px', display: 'flex', gap: '24px', flexWrap: 'wrap', borderBottom: `1px solid ${colors.border}` }}>
                                      <div><span style={{ fontSize: '11px', color: colors.slateLight }}>Type</span><div style={{ fontWeight: 600, color: colors.slate, fontSize: '13px' }}>Credit Memo</div></div>
                                      <div><span style={{ fontSize: '11px', color: colors.slateLight }}>Date</span><div style={{ fontWeight: 500, color: colors.slate, fontSize: '13px' }}>2024-01-31</div></div>
                                      <div><span style={{ fontSize: '11px', color: colors.slateLight }}>Customer</span><div style={{ fontWeight: 500, color: colors.slate, fontSize: '13px' }}>{adj.customer}</div></div>
                                      <div><span style={{ fontSize: '11px', color: colors.slateLight }}>Applied To</span><div style={{ fontWeight: 500, color: colors.secondary, fontSize: '13px' }}>INV-1038</div></div>
                                    </div>
                                    <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '12px' }}>
                                      <thead>
                                        <tr>
                                          <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight }}>Account</th>
                                          <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight }}>Description</th>
                                          <th style={{ padding: '8px 12px', textAlign: 'right', fontWeight: 600, color: colors.slateLight }}>Amount</th>
                                        </tr>
                                      </thead>
                                      <tbody>
                                        <tr>
                                          <td style={{ padding: '10px 12px' }}>
                                            <a href="#" onClick={(e) => e.preventDefault()} style={{ color: colors.secondary, textDecoration: 'none' }}>6900 - Miscellaneous Expense</a>
                                          </td>
                                          <td style={{ padding: '10px 12px', color: colors.slateLight }}>Rounding/small balance clearing - INV-1038</td>
                                          <td style={{ padding: '10px 12px', textAlign: 'right', fontWeight: 600, color: colors.warning }}>{fmt(adj.balance)}</td>
                                        </tr>
                                      </tbody>
                                    </table>
                                  </div>

                                  {/* GL Impact */}
                                  <div style={{ backgroundColor: '#FFF8E1', borderRadius: '6px', padding: '12px', marginBottom: '12px', border: `1px solid ${colors.warning}` }}>
                                    <div style={{ fontSize: '11px', fontWeight: 600, color: colors.warning, marginBottom: '4px', textTransform: 'uppercase' }}>GL Impact</div>
                                    <div style={{ fontSize: '12px', color: colors.slate }}>
                                      <strong>Dr</strong> 6900 - Miscellaneous Expense {fmt(adj.balance)} | <strong>Cr</strong> 1200 - Accounts Receivable {fmt(adj.balance)}
                                    </div>
                                  </div>

                                  {/* Linked Documents */}
                                  <div style={{ paddingTop: '12px', borderTop: `1px solid ${colors.border}` }}>
                                    <div style={{ fontSize: '11px', fontWeight: 600, color: colors.slateLight, marginBottom: '8px', textTransform: 'uppercase' }}>Related Documents</div>
                                    <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
                                      <a href="#" onClick={(e) => e.preventDefault()} style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px', color: colors.secondary, textDecoration: 'none' }}>
                                        <Icon name="file-text" size={14} /> Invoice INV-1038
                                      </a>
                                      <a href="#" onClick={(e) => e.preventDefault()} style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px', color: colors.secondary, textDecoration: 'none' }}>
                                        <Icon name="credit-card" size={14} /> Payment History
                                      </a>
                                      <a href="#" onClick={(e) => e.preventDefault()} style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px', color: colors.secondary, textDecoration: 'none' }}>
                                        <Icon name="database" size={14} /> Customer Ledger
                                      </a>
                                    </div>
                                  </div>
                                </div>
                              )}
                            </div>
                          )}

                          <div style={{ backgroundColor: colors.background, borderRadius: '6px', padding: '12px', borderLeft: `3px solid ${colors.secondary}` }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '6px', marginBottom: '6px', color: colors.secondary, fontWeight: 600, fontSize: '11px', textTransform: 'uppercase' }}>
                              <Icon name="sparkles" size={12} /> AI Reasoning
                            </div>
                            <p style={{ margin: 0, color: colors.slate, fontSize: '13px', lineHeight: 1.5, fontFamily: 'Georgia, serif' }}>{adj.reasoning}</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </Card>

                <Card style={{ marginBottom: '24px' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <div>
                      <span style={{ fontSize: '12px', color: colors.slateLight }}>Total Adjustments:</span>
                      <span style={{ fontSize: '16px', fontWeight: 700, color: colors.primary, marginLeft: '8px' }}>{fmt(adjustments.filter(a => a.approved).reduce((s, a) => s + (a.offsetAmount || a.balance || 0), 0))}</span>
                    </div>
                    <div style={{ display: 'flex', gap: '12px' }}>
                      <Button variant="secondary" onClick={() => setPhase('gap_analysis')}>Back</Button>
                      <Button onClick={() => setPhase('tieout')} iconName="check">Approve & Execute Adjustments</Button>
                    </div>
                  </div>
                </Card>
              </div>
            )}

            {/* TIE-OUT PHASE */}
            {phase === 'tieout' && (
              <div style={{ maxWidth: '900px' }}>
                <h1 style={{ fontSize: '24px', fontWeight: 700, color: colors.slate, marginBottom: '4px' }}>Reconciliation & Tie-Out</h1>
                <p style={{ fontSize: '14px', color: colors.slateLight, marginBottom: '24px' }}>Confirm QBO AR is fully reconciled to all external sources</p>

                {/* Overall Reconciliation Status */}
                <Card style={{ marginBottom: '24px', border: `2px solid ${colors.primary}` }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '16px', marginBottom: '20px' }}>
                    <div style={{ width: '56px', height: '56px', borderRadius: '12px', backgroundColor: colors.primaryLight, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                      <Icon name="check-circle" size={28} color={colors.primary} />
                    </div>
                    <div>
                      <div style={{ fontSize: '20px', fontWeight: 700, color: colors.primary }}>AR RECONCILIATION COMPLETE</div>
                      <div style={{ fontSize: '14px', color: colors.slateLight }}>5 sources compared • 6 items flagged for review or action</div>
                    </div>
                  </div>

                  {/* Reconciliation Summary Cards */}
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '10px' }}>
                    <div style={{ padding: '12px', backgroundColor: colors.primaryLight, borderRadius: '8px', border: `1px solid ${colors.primary}` }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '4px', marginBottom: '6px' }}>
                        <Icon name="check-circle" size={12} color={colors.primary} />
                        <span style={{ fontSize: '10px', fontWeight: 600, color: colors.primaryDark, textTransform: 'uppercase' }}>QBO ↔ Stripe</span>
                      </div>
                      <div style={{ fontSize: '16px', fontWeight: 700, color: colors.primary }}>Reconciled</div>
                      <div style={{ fontSize: '10px', color: colors.slateLight }}>2 invoices created</div>
                    </div>
                    <div style={{ padding: '12px', backgroundColor: colors.primaryLight, borderRadius: '8px', border: `1px solid ${colors.primary}` }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '4px', marginBottom: '6px' }}>
                        <Icon name="check-circle" size={12} color={colors.primary} />
                        <span style={{ fontSize: '10px', fontWeight: 600, color: colors.primaryDark, textTransform: 'uppercase' }}>QBO ↔ Bank</span>
                      </div>
                      <div style={{ fontSize: '16px', fontWeight: 700, color: colors.primary }}>Reconciled</div>
                      <div style={{ fontSize: '10px', color: colors.slateLight }}>4 payments matched</div>
                    </div>
                    <div style={{ padding: '12px', backgroundColor: colors.warningLight, borderRadius: '8px', border: `1px solid ${colors.warning}` }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '4px', marginBottom: '6px' }}>
                        <Icon name="alert-triangle" size={12} color={colors.warning} />
                        <span style={{ fontSize: '10px', fontWeight: 600, color: '#E65100', textTransform: 'uppercase' }}>QBO ↔ Gmail</span>
                      </div>
                      <div style={{ fontSize: '16px', fontWeight: 700, color: colors.warning }}>2 Missing</div>
                      <div style={{ fontSize: '10px', color: colors.slateLight }}>Invoices to create</div>
                    </div>
                    <div style={{ padding: '12px', backgroundColor: colors.warningLight, borderRadius: '8px', border: `1px solid ${colors.warning}` }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '4px', marginBottom: '6px' }}>
                        <Icon name="alert-triangle" size={12} color={colors.warning} />
                        <span style={{ fontSize: '10px', fontWeight: 600, color: '#E65100', textTransform: 'uppercase' }}>QBO ↔ Spreadsheet</span>
                      </div>
                      <div style={{ fontSize: '16px', fontWeight: 700, color: colors.warning }}>4 Variances</div>
                      <div style={{ fontSize: '10px', color: colors.slateLight }}>Items to resolve</div>
                    </div>
                    <div style={{ padding: '12px', backgroundColor: colors.errorLight, borderRadius: '8px', border: `1px solid ${colors.error}` }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '4px', marginBottom: '6px' }}>
                        <Icon name="x-circle" size={12} color={colors.error} />
                        <span style={{ fontSize: '10px', fontWeight: 600, color: colors.error, textTransform: 'uppercase' }}>Exceptions</span>
                      </div>
                      <div style={{ fontSize: '16px', fontWeight: 700, color: colors.error }}>2 Items</div>
                      <div style={{ fontSize: '10px', color: colors.slateLight }}>Manual review</div>
                    </div>
                  </div>
                </Card>

                {/* QBO vs External Billing Reconciliation */}
                <Card style={{ marginBottom: '16px' }}>
                  <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '16px' }}>
                    <h3 style={{ fontSize: '14px', fontWeight: 600, color: colors.slate, margin: 0, display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <Icon name="database" size={16} color={colors.secondary} /> QBO AR vs. External Billing
                    </h3>
                    <button onClick={() => toggleSection('ext_billing_recon')} style={{ display: 'flex', alignItems: 'center', gap: '4px', padding: '4px 10px', fontSize: '11px', fontWeight: 600, color: colors.secondary, backgroundColor: colors.secondaryLight, border: 'none', borderRadius: '4px', cursor: 'pointer' }}>
                      <Icon name={expandedSections['ext_billing_recon'] ? 'chevron-down' : 'chevron-right'} size={14} />
                      {expandedSections['ext_billing_recon'] ? 'Hide Details' : 'View Details'}
                    </button>
                  </div>

                  <div style={{ display: 'flex', gap: '16px', alignItems: 'center', flexWrap: 'wrap', marginBottom: '12px' }}>
                    <div style={{ padding: '12px 16px', backgroundColor: colors.background, borderRadius: '6px', textAlign: 'center', minWidth: '140px' }}>
                      <div style={{ fontSize: '11px', color: colors.slateLight }}>QBO Open AR</div>
                      <div style={{ fontSize: '20px', fontWeight: 700, color: colors.slate }}>{fmt(156750)}</div>
                    </div>
                    <div style={{ fontSize: '20px', color: colors.primary }}>≈</div>
                    <div style={{ padding: '12px 16px', backgroundColor: colors.background, borderRadius: '6px', textAlign: 'center', minWidth: '140px' }}>
                      <div style={{ fontSize: '11px', color: colors.slateLight }}>Stripe Billing</div>
                      <div style={{ fontSize: '20px', fontWeight: 700, color: colors.slate }}>{fmt(156750)}</div>
                    </div>
                    <Badge variant="successLight">Matched</Badge>
                  </div>

                  <div style={{ fontSize: '12px', color: colors.slateLight, padding: '10px', backgroundColor: '#F8F9FA', borderRadius: '6px' }}>
                    <strong style={{ color: colors.slate }}>Resolution:</strong> 2 invoices totaling {fmt(2250)} were created in QBO from Stripe billing data to close the gap.
                  </div>

                  {expandedSections['ext_billing_recon'] && (
                    <div style={{ marginTop: '16px', padding: '16px', backgroundColor: colors.background, borderRadius: '8px', border: `1px solid ${colors.border}` }}>
                      <h4 style={{ fontSize: '12px', fontWeight: 600, color: colors.slate, marginBottom: '12px' }}>Reconciliation Details</h4>
                      <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '12px' }}>
                        <thead>
                          <tr style={{ backgroundColor: colors.white }}>
                            <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Source</th>
                            <th style={{ padding: '8px 12px', textAlign: 'right', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Before Run</th>
                            <th style={{ padding: '8px 12px', textAlign: 'center', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Adjustments</th>
                            <th style={{ padding: '8px 12px', textAlign: 'right', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>After Run</th>
                            <th style={{ padding: '8px 12px', textAlign: 'center', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Status</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}>QBO AR Aging</td>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'right' }}>{fmt(154500)}</td>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'center', color: colors.primary }}>+{fmt(2250)}</td>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'right', fontWeight: 600 }}>{fmt(156750)}</td>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'center' }}><Badge variant="successLight" size="sm">✓</Badge></td>
                          </tr>
                          <tr>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}>Stripe Billing Register</td>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'right' }}>{fmt(156750)}</td>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'center', color: colors.slateLight }}>—</td>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'right', fontWeight: 600 }}>{fmt(156750)}</td>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'center' }}><Badge variant="successLight" size="sm">✓</Badge></td>
                          </tr>
                          <tr style={{ backgroundColor: colors.primaryLight }}>
                            <td style={{ padding: '10px 12px', fontWeight: 600 }}>Variance</td>
                            <td style={{ padding: '10px 12px', textAlign: 'right', color: colors.error }}>{fmt(2250)}</td>
                            <td style={{ padding: '10px 12px', textAlign: 'center' }}>→</td>
                            <td style={{ padding: '10px 12px', textAlign: 'right', fontWeight: 700, color: colors.primary }}>{fmt(0)}</td>
                            <td style={{ padding: '10px 12px', textAlign: 'center' }}><Badge variant="success" size="sm">Resolved</Badge></td>
                          </tr>
                        </tbody>
                      </table>

                      <div style={{ marginTop: '12px', paddingTop: '12px', borderTop: `1px solid ${colors.border}` }}>
                        <div style={{ fontSize: '11px', fontWeight: 600, color: colors.slateLight, marginBottom: '8px', textTransform: 'uppercase' }}>Reports</div>
                        <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
                          <a href="#" onClick={(e) => e.preventDefault()} style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px', color: colors.secondary, textDecoration: 'none' }}>
                            <Icon name="file-text" size={14} /> QBO AR Aging Detail
                          </a>
                          <a href="#" onClick={(e) => e.preventDefault()} style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px', color: colors.secondary, textDecoration: 'none' }}>
                            <Icon name="file-text" size={14} /> Stripe Billing Register
                          </a>
                          <a href="#" onClick={(e) => e.preventDefault()} style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px', color: colors.secondary, textDecoration: 'none' }}>
                            <Icon name="file-text" size={14} /> Gap Resolution Log
                          </a>
                        </div>
                      </div>
                    </div>
                  )}
                </Card>

                {/* QBO vs Bank Activity Reconciliation */}
                <Card style={{ marginBottom: '16px' }}>
                  <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '16px' }}>
                    <h3 style={{ fontSize: '14px', fontWeight: 600, color: colors.slate, margin: 0, display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <Icon name="credit-card" size={16} color={colors.teal} /> QBO AR vs. Bank Activity
                    </h3>
                    <button onClick={() => toggleSection('bank_recon')} style={{ display: 'flex', alignItems: 'center', gap: '4px', padding: '4px 10px', fontSize: '11px', fontWeight: 600, color: colors.secondary, backgroundColor: colors.secondaryLight, border: 'none', borderRadius: '4px', cursor: 'pointer' }}>
                      <Icon name={expandedSections['bank_recon'] ? 'chevron-down' : 'chevron-right'} size={14} />
                      {expandedSections['bank_recon'] ? 'Hide Details' : 'View Details'}
                    </button>
                  </div>

                  <div style={{ display: 'flex', gap: '16px', alignItems: 'center', flexWrap: 'wrap', marginBottom: '12px' }}>
                    <div style={{ padding: '12px 16px', backgroundColor: colors.background, borderRadius: '6px', textAlign: 'center', minWidth: '140px' }}>
                      <div style={{ fontSize: '11px', color: colors.slateLight }}>Bank Deposits</div>
                      <div style={{ fontSize: '20px', fontWeight: 700, color: colors.slate }}>{fmt(23700)}</div>
                    </div>
                    <div style={{ fontSize: '20px', color: colors.primary }}>→</div>
                    <div style={{ padding: '12px 16px', backgroundColor: colors.background, borderRadius: '6px', textAlign: 'center', minWidth: '140px' }}>
                      <div style={{ fontSize: '11px', color: colors.slateLight }}>Matched to AR</div>
                      <div style={{ fontSize: '20px', fontWeight: 700, color: colors.primary }}>{fmt(20000)}</div>
                    </div>
                    <div style={{ padding: '12px 16px', backgroundColor: colors.warningLight, borderRadius: '6px', textAlign: 'center', minWidth: '140px' }}>
                      <div style={{ fontSize: '11px', color: colors.slateLight }}>Unmatched</div>
                      <div style={{ fontSize: '20px', fontWeight: 700, color: colors.warning }}>{fmt(3700)}</div>
                    </div>
                  </div>

                  <div style={{ fontSize: '12px', color: colors.slateLight, padding: '10px', backgroundColor: '#F8F9FA', borderRadius: '6px' }}>
                    <strong style={{ color: colors.slate }}>Status:</strong> 4 payments totaling {fmt(20000)} matched and applied. {fmt(3700)} in deposits require manual investigation (see Exceptions below).
                  </div>

                  {expandedSections['bank_recon'] && (
                    <div style={{ marginTop: '16px', padding: '16px', backgroundColor: colors.background, borderRadius: '8px', border: `1px solid ${colors.border}` }}>
                      <h4 style={{ fontSize: '12px', fontWeight: 600, color: colors.slate, marginBottom: '12px' }}>Payment Matching Summary</h4>
                      <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '12px' }}>
                        <thead>
                          <tr style={{ backgroundColor: colors.white }}>
                            <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Payment</th>
                            <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Customer</th>
                            <th style={{ padding: '8px 12px', textAlign: 'right', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Amount</th>
                            <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Applied To</th>
                            <th style={{ padding: '8px 12px', textAlign: 'center', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Status</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}><a href="#" onClick={(e) => e.preventDefault()} style={{ color: colors.secondary, textDecoration: 'none' }}>PMT-5501</a></td>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}>Acme Corp</td>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'right' }}>{fmt(6000)}</td>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}>INV-1042, INV-1045</td>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'center' }}><Badge variant="successLight" size="sm">Applied</Badge></td>
                          </tr>
                          <tr>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}><a href="#" onClick={(e) => e.preventDefault()} style={{ color: colors.secondary, textDecoration: 'none' }}>PMT-5502</a></td>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}>TechStart LLC</td>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'right' }}>{fmt(2250)}</td>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}>INV-1043</td>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'center' }}><Badge variant="successLight" size="sm">Applied</Badge></td>
                          </tr>
                          <tr>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}><a href="#" onClick={(e) => e.preventDefault()} style={{ color: colors.secondary, textDecoration: 'none' }}>PMT-5503</a></td>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}>Global Industries</td>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'right' }}>{fmt(8750)}</td>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}>INV-1044</td>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'center' }}><Badge variant="successLight" size="sm">Applied</Badge></td>
                          </tr>
                          <tr>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}><a href="#" onClick={(e) => e.preventDefault()} style={{ color: colors.secondary, textDecoration: 'none' }}>PMT-5504</a></td>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}>Smith & Co</td>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'right' }}>{fmt(3000)}</td>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}>INV-1046 (partial)</td>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'center' }}><Badge variant="successLight" size="sm">Applied</Badge></td>
                          </tr>
                          <tr style={{ backgroundColor: colors.warningLight }}>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}><a href="#" onClick={(e) => e.preventDefault()} style={{ color: colors.secondary, textDecoration: 'none' }}>PMT-5505</a></td>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}>Unknown Sender</td>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'right' }}>{fmt(1200)}</td>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, color: colors.slateLight, fontStyle: 'italic' }}>—</td>
                            <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'center' }}><Badge variant="warningLight" size="sm">Unmatched</Badge></td>
                          </tr>
                          <tr style={{ backgroundColor: colors.warningLight }}>
                            <td style={{ padding: '10px 12px' }}><a href="#" onClick={(e) => e.preventDefault()} style={{ color: colors.secondary, textDecoration: 'none' }}>DEP-001</a></td>
                            <td style={{ padding: '10px 12px' }}>TechStart LLC (Bank)</td>
                            <td style={{ padding: '10px 12px', textAlign: 'right' }}>{fmt(2500)}</td>
                            <td style={{ padding: '10px 12px', color: colors.slateLight, fontStyle: 'italic' }}>Ghost Cash</td>
                            <td style={{ padding: '10px 12px', textAlign: 'center' }}><Badge variant="warningLight" size="sm">Investigate</Badge></td>
                          </tr>
                        </tbody>
                      </table>

                      <div style={{ marginTop: '12px', paddingTop: '12px', borderTop: `1px solid ${colors.border}` }}>
                        <div style={{ fontSize: '11px', fontWeight: 600, color: colors.slateLight, marginBottom: '8px', textTransform: 'uppercase' }}>Reports</div>
                        <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
                          <a href="#" onClick={(e) => e.preventDefault()} style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px', color: colors.secondary, textDecoration: 'none' }}>
                            <Icon name="file-text" size={14} /> Bank Statement
                          </a>
                          <a href="#" onClick={(e) => e.preventDefault()} style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px', color: colors.secondary, textDecoration: 'none' }}>
                            <Icon name="file-text" size={14} /> Payment Application Log
                          </a>
                          <a href="#" onClick={(e) => e.preventDefault()} style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px', color: colors.secondary, textDecoration: 'none' }}>
                            <Icon name="file-text" size={14} /> Unapplied Payments Report
                          </a>
                        </div>
                      </div>
                    </div>
                  )}
                </Card>

                {/* QBO vs Gmail Reconciliation */}
                <Card style={{ marginBottom: '16px' }}>
                  <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '16px' }}>
                    <h3 style={{ fontSize: '14px', fontWeight: 600, color: colors.slate, margin: 0, display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <Icon name="file-text" size={16} color={colors.error} /> QBO AR vs. Gmail (Parsed Invoices & Receipts)
                    </h3>
                    <button onClick={() => toggleSection('gmail_recon')} style={{ display: 'flex', alignItems: 'center', gap: '4px', padding: '4px 10px', fontSize: '11px', fontWeight: 600, color: colors.secondary, backgroundColor: colors.secondaryLight, border: 'none', borderRadius: '4px', cursor: 'pointer' }}>
                      <Icon name={expandedSections['gmail_recon'] ? 'chevron-down' : 'chevron-right'} size={14} />
                      {expandedSections['gmail_recon'] ? 'Hide Details' : 'View Details'}
                    </button>
                  </div>

                  <div style={{ display: 'flex', gap: '16px', alignItems: 'center', flexWrap: 'wrap', marginBottom: '12px' }}>
                    <div style={{ padding: '12px 16px', backgroundColor: colors.background, borderRadius: '6px', textAlign: 'center', minWidth: '120px' }}>
                      <div style={{ fontSize: '11px', color: colors.slateLight }}>Emails Scanned</div>
                      <div style={{ fontSize: '20px', fontWeight: 700, color: colors.slate }}>38</div>
                    </div>
                    <div style={{ padding: '12px 16px', backgroundColor: colors.background, borderRadius: '6px', textAlign: 'center', minWidth: '120px' }}>
                      <div style={{ fontSize: '11px', color: colors.slateLight }}>Invoices Found</div>
                      <div style={{ fontSize: '20px', fontWeight: 700, color: colors.slate }}>23</div>
                    </div>
                    <div style={{ padding: '12px 16px', backgroundColor: colors.primaryLight, borderRadius: '6px', textAlign: 'center', minWidth: '120px' }}>
                      <div style={{ fontSize: '11px', color: colors.slateLight }}>Matched to QBO</div>
                      <div style={{ fontSize: '20px', fontWeight: 700, color: colors.primary }}>21</div>
                    </div>
                    <div style={{ padding: '12px 16px', backgroundColor: colors.warningLight, borderRadius: '6px', textAlign: 'center', minWidth: '120px' }}>
                      <div style={{ fontSize: '11px', color: colors.slateLight }}>Missing in QBO</div>
                      <div style={{ fontSize: '20px', fontWeight: 700, color: colors.warning }}>2</div>
                    </div>
                  </div>

                  <div style={{ fontSize: '12px', color: colors.slateLight, padding: '10px', backgroundColor: '#F8F9FA', borderRadius: '6px' }}>
                    <strong style={{ color: colors.slate }}>Status:</strong> Parsed 38 emails with invoice attachments and payment confirmations. 2 invoices found in Gmail that don't exist in QBO, totaling {fmt(4075)}.
                  </div>

                  {expandedSections['gmail_recon'] && (
                    <div style={{ marginTop: '16px', padding: '16px', backgroundColor: colors.background, borderRadius: '8px', border: `1px solid ${colors.border}` }}>
                      {/* Missing Invoices from Gmail */}
                      <div style={{ marginBottom: '16px' }}>
                        <h4 style={{ fontSize: '12px', fontWeight: 600, color: colors.slate, marginBottom: '12px', display: 'flex', alignItems: 'center', gap: '6px' }}>
                          <Icon name="alert-triangle" size={14} color={colors.warning} /> Invoices in Gmail Not Found in QBO
                        </h4>
                        <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '12px' }}>
                          <thead>
                            <tr style={{ backgroundColor: colors.white }}>
                              <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Email Subject</th>
                              <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>From</th>
                              <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Date</th>
                              <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Customer</th>
                              <th style={{ padding: '8px 12px', textAlign: 'right', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Amount</th>
                              <th style={{ padding: '8px 12px', textAlign: 'center', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Action</th>
                            </tr>
                          </thead>
                          <tbody>
                            {mockGmailInvoices.filter(g => g.matchStatus === 'missing_in_qbo').map((inv, idx) => (
                              <tr key={idx} style={{ backgroundColor: colors.warningLight }}>
                                <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}>
                                  <div style={{ fontWeight: 500, color: colors.slate }}>{inv.subject}</div>
                                  <div style={{ fontSize: '10px', color: colors.slateLight }}>{inv.attachmentName}</div>
                                </td>
                                <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, fontSize: '11px', color: colors.slateLight }}>{inv.sender}</td>
                                <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}>{inv.date}</td>
                                <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}>{inv.customer}</td>
                                <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'right', fontWeight: 600, color: colors.warning }}>{fmt(inv.amount)}</td>
                                <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'center' }}>
                                  <Badge variant="warningLight" size="sm">Create Invoice</Badge>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>

                      {/* Unmatched Payment Confirmations */}
                      <div style={{ marginBottom: '16px' }}>
                        <h4 style={{ fontSize: '12px', fontWeight: 600, color: colors.slate, marginBottom: '12px', display: 'flex', alignItems: 'center', gap: '6px' }}>
                          <Icon name="alert-triangle" size={14} color={colors.warning} /> Payment Confirmations Not Matched in QBO
                        </h4>
                        <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '12px' }}>
                          <thead>
                            <tr style={{ backgroundColor: colors.white }}>
                              <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Email Subject</th>
                              <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>From</th>
                              <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Date</th>
                              <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Customer</th>
                              <th style={{ padding: '8px 12px', textAlign: 'right', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Amount</th>
                              <th style={{ padding: '8px 12px', textAlign: 'center', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Status</th>
                            </tr>
                          </thead>
                          <tbody>
                            {mockGmailPayments.filter(g => g.matchStatus === 'missing_in_qbo').map((pmt, idx) => (
                              <tr key={idx} style={{ backgroundColor: colors.warningLight }}>
                                <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}>
                                  <div style={{ fontWeight: 500, color: colors.slate }}>{pmt.subject}</div>
                                </td>
                                <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, fontSize: '11px', color: colors.slateLight }}>{pmt.sender}</td>
                                <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}>{pmt.date}</td>
                                <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}>{pmt.customer}</td>
                                <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'right', fontWeight: 600, color: colors.warning }}>{fmt(pmt.amount)}</td>
                                <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'center' }}>
                                  <Badge variant="warningLight" size="sm">Investigate</Badge>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>

                      <div style={{ paddingTop: '12px', borderTop: `1px solid ${colors.border}` }}>
                        <div style={{ fontSize: '11px', fontWeight: 600, color: colors.slateLight, marginBottom: '8px', textTransform: 'uppercase' }}>Reports & Links</div>
                        <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
                          <a href="#" onClick={(e) => e.preventDefault()} style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px', color: colors.secondary, textDecoration: 'none' }}>
                            <Icon name="file-text" size={14} /> Gmail Scan Log
                          </a>
                          <a href="#" onClick={(e) => e.preventDefault()} style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px', color: colors.secondary, textDecoration: 'none' }}>
                            <Icon name="file-text" size={14} /> Extracted Invoices List
                          </a>
                          <a href="#" onClick={(e) => e.preventDefault()} style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px', color: colors.secondary, textDecoration: 'none' }}>
                            <Icon name="external-link" size={14} /> Open Gmail
                          </a>
                        </div>
                      </div>
                    </div>
                  )}
                </Card>

                {/* QBO vs Spreadsheet Upload Reconciliation */}
                <Card style={{ marginBottom: '16px' }}>
                  <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '16px' }}>
                    <h3 style={{ fontSize: '14px', fontWeight: 600, color: colors.slate, margin: 0, display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <Icon name="upload" size={16} color={colors.purple} /> QBO AR vs. Transaction Spreadsheet
                    </h3>
                    <button onClick={() => toggleSection('spreadsheet_recon')} style={{ display: 'flex', alignItems: 'center', gap: '4px', padding: '4px 10px', fontSize: '11px', fontWeight: 600, color: colors.secondary, backgroundColor: colors.secondaryLight, border: 'none', borderRadius: '4px', cursor: 'pointer' }}>
                      <Icon name={expandedSections['spreadsheet_recon'] ? 'chevron-down' : 'chevron-right'} size={14} />
                      {expandedSections['spreadsheet_recon'] ? 'Hide Details' : 'View Details'}
                    </button>
                  </div>

                  {/* File Info */}
                  <div style={{ display: 'flex', alignItems: 'center', gap: '12px', padding: '12px', backgroundColor: colors.purpleLight, borderRadius: '6px', marginBottom: '16px' }}>
                    <Icon name="file-text" size={24} color={colors.purple} />
                    <div>
                      <div style={{ fontWeight: 600, color: colors.slate }}>{mockSpreadsheetData.fileName}</div>
                      <div style={{ fontSize: '11px', color: colors.slateLight }}>Uploaded {mockSpreadsheetData.uploadDate} • {mockSpreadsheetData.totalRecords} records</div>
                    </div>
                  </div>

                  <div style={{ display: 'flex', gap: '12px', alignItems: 'center', flexWrap: 'wrap', marginBottom: '12px' }}>
                    <div style={{ padding: '12px 16px', backgroundColor: colors.background, borderRadius: '6px', textAlign: 'center', minWidth: '100px' }}>
                      <div style={{ fontSize: '11px', color: colors.slateLight }}>Invoices</div>
                      <div style={{ fontSize: '18px', fontWeight: 700, color: colors.slate }}>{mockSpreadsheetData.summary.invoices.count}</div>
                      <div style={{ fontSize: '10px', color: colors.slateLight }}>{fmt(mockSpreadsheetData.summary.invoices.total)}</div>
                    </div>
                    <div style={{ padding: '12px 16px', backgroundColor: colors.background, borderRadius: '6px', textAlign: 'center', minWidth: '100px' }}>
                      <div style={{ fontSize: '11px', color: colors.slateLight }}>Payments</div>
                      <div style={{ fontSize: '18px', fontWeight: 700, color: colors.slate }}>{mockSpreadsheetData.summary.payments.count}</div>
                      <div style={{ fontSize: '10px', color: colors.slateLight }}>{fmt(mockSpreadsheetData.summary.payments.total)}</div>
                    </div>
                    <div style={{ padding: '12px 16px', backgroundColor: colors.background, borderRadius: '6px', textAlign: 'center', minWidth: '100px' }}>
                      <div style={{ fontSize: '11px', color: colors.slateLight }}>Credits</div>
                      <div style={{ fontSize: '18px', fontWeight: 700, color: colors.slate }}>{mockSpreadsheetData.summary.credits.count}</div>
                      <div style={{ fontSize: '10px', color: colors.slateLight }}>{fmt(mockSpreadsheetData.summary.credits.total)}</div>
                    </div>
                    <div style={{ fontSize: '20px', color: colors.primary }}>→</div>
                    <div style={{ padding: '12px 16px', backgroundColor: colors.warningLight, borderRadius: '6px', textAlign: 'center', minWidth: '120px' }}>
                      <div style={{ fontSize: '11px', color: colors.slateLight }}>Discrepancies</div>
                      <div style={{ fontSize: '18px', fontWeight: 700, color: colors.warning }}>{mockSpreadsheetData.discrepancies.length}</div>
                      <div style={{ fontSize: '10px', color: colors.slateLight }}>items to resolve</div>
                    </div>
                  </div>

                  <div style={{ fontSize: '12px', color: colors.slateLight, padding: '10px', backgroundColor: '#F8F9FA', borderRadius: '6px' }}>
                    <strong style={{ color: colors.slate }}>Status:</strong> Compared {mockSpreadsheetData.totalRecords} transactions from spreadsheet against QBO. Found {mockSpreadsheetData.discrepancies.length} discrepancies requiring action.
                  </div>

                  {expandedSections['spreadsheet_recon'] && (
                    <div style={{ marginTop: '16px', padding: '16px', backgroundColor: colors.background, borderRadius: '8px', border: `1px solid ${colors.border}` }}>
                      {/* Match Summary */}
                      <div style={{ marginBottom: '16px' }}>
                        <h4 style={{ fontSize: '12px', fontWeight: 600, color: colors.slate, marginBottom: '12px' }}>Match Summary</h4>
                        <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
                          <div style={{ padding: '10px 14px', backgroundColor: colors.primaryLight, borderRadius: '6px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <Icon name="check-circle" size={16} color={colors.primary} />
                            <div>
                              <div style={{ fontSize: '14px', fontWeight: 600, color: colors.primary }}>{mockSpreadsheetData.matched.invoices}/{mockSpreadsheetData.summary.invoices.count}</div>
                              <div style={{ fontSize: '10px', color: colors.slateLight }}>Invoices Matched</div>
                            </div>
                          </div>
                          <div style={{ padding: '10px 14px', backgroundColor: colors.primaryLight, borderRadius: '6px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <Icon name="check-circle" size={16} color={colors.primary} />
                            <div>
                              <div style={{ fontSize: '14px', fontWeight: 600, color: colors.primary }}>{mockSpreadsheetData.matched.payments}/{mockSpreadsheetData.summary.payments.count}</div>
                              <div style={{ fontSize: '10px', color: colors.slateLight }}>Payments Matched</div>
                            </div>
                          </div>
                          <div style={{ padding: '10px 14px', backgroundColor: colors.primaryLight, borderRadius: '6px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <Icon name="check-circle" size={16} color={colors.primary} />
                            <div>
                              <div style={{ fontSize: '14px', fontWeight: 600, color: colors.primary }}>{mockSpreadsheetData.matched.credits}/{mockSpreadsheetData.summary.credits.count}</div>
                              <div style={{ fontSize: '10px', color: colors.slateLight }}>Credits Matched</div>
                            </div>
                          </div>
                        </div>
                      </div>

                      {/* Discrepancies */}
                      <div style={{ marginBottom: '16px' }}>
                        <h4 style={{ fontSize: '12px', fontWeight: 600, color: colors.slate, marginBottom: '12px', display: 'flex', alignItems: 'center', gap: '6px' }}>
                          <Icon name="alert-triangle" size={14} color={colors.warning} /> Discrepancies Found
                        </h4>
                        <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '12px' }}>
                          <thead>
                            <tr style={{ backgroundColor: colors.white }}>
                              <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Type</th>
                              <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Reference</th>
                              <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Customer</th>
                              <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Date</th>
                              <th style={{ padding: '8px 12px', textAlign: 'right', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Amount</th>
                              <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Issue</th>
                              <th style={{ padding: '8px 12px', textAlign: 'center', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Action</th>
                            </tr>
                          </thead>
                          <tbody>
                            {mockSpreadsheetData.discrepancies.map((disc, idx) => (
                              <tr key={idx} style={{ backgroundColor: colors.warningLight }}>
                                <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}>
                                  <Badge variant={disc.type === 'invoice' ? 'purpleLight' : disc.type === 'payment' ? 'blueLight' : 'tealLight'} size="sm">{disc.type}</Badge>
                                </td>
                                <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, fontFamily: 'monospace', fontSize: '11px' }}>{disc.ref}</td>
                                <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}>{disc.customer}</td>
                                <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}` }}>{disc.date}</td>
                                <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'right', fontWeight: 600 }}>{fmt(disc.amount)}</td>
                                <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, fontSize: '11px', color: colors.warning }}>{disc.issue}</td>
                                <td style={{ padding: '10px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'center' }}>
                                  <Badge variant={disc.action === 'investigate' ? 'warningLight' : 'blueLight'} size="sm">
                                    {disc.action === 'create_invoice' ? 'Create' : disc.action === 'create_credit' ? 'Create' : 'Investigate'}
                                  </Badge>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>

                      <div style={{ paddingTop: '12px', borderTop: `1px solid ${colors.border}` }}>
                        <div style={{ fontSize: '11px', fontWeight: 600, color: colors.slateLight, marginBottom: '8px', textTransform: 'uppercase' }}>Reports & Files</div>
                        <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
                          <a href="#" onClick={(e) => e.preventDefault()} style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px', color: colors.secondary, textDecoration: 'none' }}>
                            <Icon name="file-text" size={14} /> Original Spreadsheet
                          </a>
                          <a href="#" onClick={(e) => e.preventDefault()} style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px', color: colors.secondary, textDecoration: 'none' }}>
                            <Icon name="file-text" size={14} /> Comparison Report
                          </a>
                          <a href="#" onClick={(e) => e.preventDefault()} style={{ display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px', color: colors.secondary, textDecoration: 'none' }}>
                            <Icon name="download" size={14} /> Export Discrepancies
                          </a>
                        </div>
                      </div>
                    </div>
                  )}
                </Card>

                {/* Run Summary */}
                <Card style={{ marginBottom: '16px' }}>
                  <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '16px' }}>
                    <h3 style={{ fontSize: '14px', fontWeight: 600, color: colors.slate, margin: 0, display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <Icon name="clipboard" size={16} color={colors.purple} /> AR Close Run Summary
                    </h3>
                    <button onClick={() => toggleSection('run_summary')} style={{ display: 'flex', alignItems: 'center', gap: '4px', padding: '4px 10px', fontSize: '11px', fontWeight: 600, color: colors.secondary, backgroundColor: colors.secondaryLight, border: 'none', borderRadius: '4px', cursor: 'pointer' }}>
                      <Icon name={expandedSections['run_summary'] ? 'chevron-down' : 'chevron-right'} size={14} />
                      {expandedSections['run_summary'] ? 'Hide Details' : 'View Details'}
                    </button>
                  </div>

                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '12px', marginBottom: '16px' }}>
                    <div style={{ padding: '12px', backgroundColor: colors.background, borderRadius: '6px', textAlign: 'center' }}>
                      <div style={{ fontSize: '24px', fontWeight: 700, color: colors.primary }}>4</div>
                      <div style={{ fontSize: '11px', color: colors.slateLight }}>Payments Applied</div>
                    </div>
                    <div style={{ padding: '12px', backgroundColor: colors.background, borderRadius: '6px', textAlign: 'center' }}>
                      <div style={{ fontSize: '24px', fontWeight: 700, color: colors.secondary }}>2</div>
                      <div style={{ fontSize: '11px', color: colors.slateLight }}>Invoices Created</div>
                    </div>
                    <div style={{ padding: '12px', backgroundColor: colors.background, borderRadius: '6px', textAlign: 'center' }}>
                      <div style={{ fontSize: '24px', fontWeight: 700, color: colors.purple }}>3</div>
                      <div style={{ fontSize: '11px', color: colors.slateLight }}>Adjustments Posted</div>
                    </div>
                    <div style={{ padding: '12px', backgroundColor: colors.background, borderRadius: '6px', textAlign: 'center' }}>
                      <div style={{ fontSize: '24px', fontWeight: 700, color: colors.warning }}>2</div>
                      <div style={{ fontSize: '11px', color: colors.slateLight }}>Exceptions</div>
                    </div>
                  </div>

                  {expandedSections['run_summary'] && (
                    <div style={{ padding: '16px', backgroundColor: colors.background, borderRadius: '8px', border: `1px solid ${colors.border}` }}>
                      <div style={{ marginBottom: '16px' }}>
                        <div style={{ fontSize: '12px', fontWeight: 600, color: colors.slate, marginBottom: '8px' }}>Transactions Created</div>
                        <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '12px' }}>
                          <thead>
                            <tr style={{ backgroundColor: colors.white }}>
                              <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Type</th>
                              <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Reference</th>
                              <th style={{ padding: '8px 12px', textAlign: 'left', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Description</th>
                              <th style={{ padding: '8px 12px', textAlign: 'right', fontWeight: 600, color: colors.slateLight, borderBottom: `1px solid ${colors.border}` }}>Amount</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr>
                              <td style={{ padding: '8px 12px', borderBottom: `1px solid ${colors.border}` }}><Badge variant="blueLight" size="sm">Payment</Badge></td>
                              <td style={{ padding: '8px 12px', borderBottom: `1px solid ${colors.border}` }}><a href="#" onClick={(e) => e.preventDefault()} style={{ color: colors.secondary, textDecoration: 'none' }}>PMT-5501</a></td>
                              <td style={{ padding: '8px 12px', borderBottom: `1px solid ${colors.border}` }}>Applied to INV-1042, INV-1045</td>
                              <td style={{ padding: '8px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'right' }}>{fmt(6000)}</td>
                            </tr>
                            <tr>
                              <td style={{ padding: '8px 12px', borderBottom: `1px solid ${colors.border}` }}><Badge variant="blueLight" size="sm">Payment</Badge></td>
                              <td style={{ padding: '8px 12px', borderBottom: `1px solid ${colors.border}` }}><a href="#" onClick={(e) => e.preventDefault()} style={{ color: colors.secondary, textDecoration: 'none' }}>PMT-5502</a></td>
                              <td style={{ padding: '8px 12px', borderBottom: `1px solid ${colors.border}` }}>Applied to INV-1043</td>
                              <td style={{ padding: '8px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'right' }}>{fmt(2250)}</td>
                            </tr>
                            <tr>
                              <td style={{ padding: '8px 12px', borderBottom: `1px solid ${colors.border}` }}><Badge variant="blueLight" size="sm">Payment</Badge></td>
                              <td style={{ padding: '8px 12px', borderBottom: `1px solid ${colors.border}` }}><a href="#" onClick={(e) => e.preventDefault()} style={{ color: colors.secondary, textDecoration: 'none' }}>PMT-5503</a></td>
                              <td style={{ padding: '8px 12px', borderBottom: `1px solid ${colors.border}` }}>Applied to INV-1044</td>
                              <td style={{ padding: '8px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'right' }}>{fmt(8750)}</td>
                            </tr>
                            <tr>
                              <td style={{ padding: '8px 12px', borderBottom: `1px solid ${colors.border}` }}><Badge variant="blueLight" size="sm">Payment</Badge></td>
                              <td style={{ padding: '8px 12px', borderBottom: `1px solid ${colors.border}` }}><a href="#" onClick={(e) => e.preventDefault()} style={{ color: colors.secondary, textDecoration: 'none' }}>PMT-5504</a></td>
                              <td style={{ padding: '8px 12px', borderBottom: `1px solid ${colors.border}` }}>Applied to INV-1046 (partial + write-off)</td>
                              <td style={{ padding: '8px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'right' }}>{fmt(3000)}</td>
                            </tr>
                            <tr>
                              <td style={{ padding: '8px 12px', borderBottom: `1px solid ${colors.border}` }}><Badge variant="purpleLight" size="sm">Invoice</Badge></td>
                              <td style={{ padding: '8px 12px', borderBottom: `1px solid ${colors.border}` }}><a href="#" onClick={(e) => e.preventDefault()} style={{ color: colors.secondary, textDecoration: 'none' }}>INV-1047</a></td>
                              <td style={{ padding: '8px 12px', borderBottom: `1px solid ${colors.border}` }}>NewCo Inc (from Stripe STRIPE-8821)</td>
                              <td style={{ padding: '8px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'right' }}>{fmt(1500)}</td>
                            </tr>
                            <tr>
                              <td style={{ padding: '8px 12px', borderBottom: `1px solid ${colors.border}` }}><Badge variant="purpleLight" size="sm">Invoice</Badge></td>
                              <td style={{ padding: '8px 12px', borderBottom: `1px solid ${colors.border}` }}><a href="#" onClick={(e) => e.preventDefault()} style={{ color: colors.secondary, textDecoration: 'none' }}>INV-1048</a></td>
                              <td style={{ padding: '8px 12px', borderBottom: `1px solid ${colors.border}` }}>FastGrow LLC (from Stripe STRIPE-8834)</td>
                              <td style={{ padding: '8px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'right' }}>{fmt(750)}</td>
                            </tr>
                            <tr>
                              <td style={{ padding: '8px 12px', borderBottom: `1px solid ${colors.border}` }}><Badge variant="tealLight" size="sm">Journal Entry</Badge></td>
                              <td style={{ padding: '8px 12px', borderBottom: `1px solid ${colors.border}` }}><a href="#" onClick={(e) => e.preventDefault()} style={{ color: colors.secondary, textDecoration: 'none' }}>JE-NET-ACME-0131</a></td>
                              <td style={{ padding: '8px 12px', borderBottom: `1px solid ${colors.border}` }}>AR/AP Netting - Acme Corp</td>
                              <td style={{ padding: '8px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'right' }}>{fmt(1200)}</td>
                            </tr>
                            <tr>
                              <td style={{ padding: '8px 12px', borderBottom: `1px solid ${colors.border}` }}><Badge variant="errorLight" size="sm">Credit Memo</Badge></td>
                              <td style={{ padding: '8px 12px', borderBottom: `1px solid ${colors.border}` }}><a href="#" onClick={(e) => e.preventDefault()} style={{ color: colors.secondary, textDecoration: 'none' }}>CM-0042</a></td>
                              <td style={{ padding: '8px 12px', borderBottom: `1px solid ${colors.border}` }}>Bad Debt Write-off - Old Client Inc</td>
                              <td style={{ padding: '8px 12px', borderBottom: `1px solid ${colors.border}`, textAlign: 'right' }}>{fmt(125)}</td>
                            </tr>
                            <tr>
                              <td style={{ padding: '8px 12px' }}><Badge variant="warningLight" size="sm">Credit Memo</Badge></td>
                              <td style={{ padding: '8px 12px' }}><a href="#" onClick={(e) => e.preventDefault()} style={{ color: colors.secondary, textDecoration: 'none' }}>CM-0043</a></td>
                              <td style={{ padding: '8px 12px' }}>Small Balance Clearing - Beta Holdings</td>
                              <td style={{ padding: '8px 12px', textAlign: 'right' }}>{fmt(0.47)}</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>

                      <Button variant="secondary" size="sm" iconName="download">Download Full Audit Log</Button>
                    </div>
                  )}
                </Card>

                {/* Exception Report */}
                <Card style={{ marginBottom: '24px' }}>
                  <h3 style={{ fontSize: '14px', fontWeight: 600, color: colors.slate, marginBottom: '12px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                    <Icon name="alert-triangle" size={16} color={colors.warning} /> Exceptions Requiring Manual Review
                  </h3>
                  <p style={{ fontSize: '12px', color: colors.slateLight, marginBottom: '16px' }}>These items could not be automatically resolved and need human investigation.</p>

                  <div style={{ padding: '14px', border: `1px solid ${colors.warning}`, borderRadius: '8px', marginBottom: '12px', backgroundColor: colors.warningLight }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '8px' }}>
                      <div>
                        <div style={{ fontWeight: 600, color: colors.slate, marginBottom: '4px' }}>Unmatched Payment - Unknown Sender</div>
                        <div style={{ fontSize: '12px', color: colors.slateLight }}>PMT-5505 • ACH-9912 • {fmt(1200)} • Received 2024-01-25</div>
                      </div>
                      <Badge variant="warning">Manual Review</Badge>
                    </div>
                    <div style={{ fontSize: '12px', color: colors.slate, padding: '8px', backgroundColor: colors.white, borderRadius: '4px', marginBottom: '8px' }}>
                      <strong>Issue:</strong> No customer match found. ACH originated from unknown sender with no memo or remittance advice.
                    </div>
                    <div style={{ display: 'flex', gap: '8px' }}>
                      <a href="#" onClick={(e) => e.preventDefault()} style={{ fontSize: '11px', color: colors.secondary, textDecoration: 'none' }}>View Payment →</a>
                      <a href="#" onClick={(e) => e.preventDefault()} style={{ fontSize: '11px', color: colors.secondary, textDecoration: 'none' }}>Bank Statement →</a>
                    </div>
                  </div>

                  <div style={{ padding: '14px', border: `1px solid ${colors.warning}`, borderRadius: '8px', backgroundColor: colors.warningLight }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '8px' }}>
                      <div>
                        <div style={{ fontWeight: 600, color: colors.slate, marginBottom: '4px' }}>Ghost Cash - Bank Deposit with No QBO Payment</div>
                        <div style={{ fontSize: '12px', color: colors.slateLight }}>DEP-001 • "DEPOSIT TECHSTART LLC" • {fmt(2500)} • 2024-01-31</div>
                      </div>
                      <Badge variant="warning">Investigate</Badge>
                    </div>
                    <div style={{ fontSize: '12px', color: colors.slate, padding: '8px', backgroundColor: colors.white, borderRadius: '4px', marginBottom: '8px' }}>
                      <strong>Issue:</strong> Bank deposit references TechStart LLC but no matching payment exists in QBO. Could be an advance payment or missing invoice.
                    </div>
                    <div style={{ display: 'flex', gap: '8px' }}>
                      <a href="#" onClick={(e) => e.preventDefault()} style={{ fontSize: '11px', color: colors.secondary, textDecoration: 'none' }}>Bank Statement →</a>
                      <a href="#" onClick={(e) => e.preventDefault()} style={{ fontSize: '11px', color: colors.secondary, textDecoration: 'none' }}>TechStart Customer Record →</a>
                    </div>
                  </div>
                </Card>

                {/* Final Actions */}
                <Card style={{ marginBottom: '24px', border: `2px solid ${colors.primary}` }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '16px' }}>
                    <Icon name="check-circle" size={24} color={colors.primary} />
                    <div>
                      <div style={{ fontWeight: 600, color: colors.slate }}>Ready to Complete AR Close</div>
                      <div style={{ fontSize: '12px', color: colors.slateLight }}>All reconciliations complete. 2 exceptions flagged for manual follow-up.</div>
                    </div>
                  </div>
                  <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
                    <Button variant="secondary" onClick={() => setPhase('adjustments')}>Back to Adjustments</Button>
                    <Button variant="secondary" iconName="download">Export Close Package</Button>
                    <Button iconName="check-circle">Complete AR Close Run</Button>
                  </div>
                </Card>
              </div>
            )}

          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
